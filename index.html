<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Rust 2D: Stable Nature</title>
<style>
    body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; user-select: none; }
    canvas { display: block; }

    /* UI Layers */
    #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
    .pointer { pointer-events: auto; }

    /* HUD */
    #hud { position: absolute; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 8px; z-index: 20; }
    .bar { width: 250px; height: 25px; background: rgba(0,0,0,0.8); border: 2px solid #555; border-radius: 4px; overflow: hidden; position: relative; }
    .fill { height: 100%; transition: width 0.2s; }
    .bar-text { position: absolute; right: 10px; top: 0; font-size: 14px; color: white; font-weight: bold; line-height: 25px; text-shadow: 1px 1px 1px #000; }

    /* HOTBAR */
    #hotbar { 
        position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); 
        display: flex; gap: 8px; padding: 10px; 
        background: rgba(30,30,30,0.8); border-radius: 10px; border: 1px solid #666; 
        pointer-events: auto; z-index: 20;
    }
    .slot { 
        width: 65px; height: 65px; 
        background: rgba(60,60,60,0.6); border: 2px solid #555; 
        color: white; display: flex; flex-direction: column; align-items: center; justify-content: center;
        cursor: pointer; position: relative; border-radius: 6px;
    }
    .slot:hover { background: rgba(90,90,90,0.8); border-color: #fff; }
    .slot.active { border-color: #76ff03; box-shadow: 0 0 15px rgba(118,255,3,0.3); transform: translateY(-3px); }
    .slot-icon { font-size: 32px; filter: drop-shadow(0 2px 2px black); pointer-events: none; }
    .slot-count { position: absolute; bottom: 2px; right: 4px; font-weight: bold; font-size: 14px; pointer-events: none; text-shadow: 1px 1px 0 #000; }

    /* MENUS */
    .menu-overlay { 
        position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.85); display: none; 
        justify-content: center; align-items: center; z-index: 100; pointer-events: auto;
    }
    .panel { 
        background: #2b2b2b; border: 2px solid #555; padding: 30px; color: #eee; border-radius: 8px; 
        box-shadow: 0 20px 50px rgba(0,0,0,1); display: flex; gap: 30px; 
    }
    .inv-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; }
    
    /* CRAFT */
    .craft-list { width: 300px; height: 400px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 4px; }
    .craft-row { 
        display: flex; justify-content: space-between; align-items: center; 
        padding: 10px; background: #383838; margin-bottom: 5px; 
        cursor: pointer; border: 1px solid #444; 
    }
    .craft-row:hover { background: #555; border-color: #999; }
    .craft-req { font-size: 11px; color: #aaa; }

    /* DRAG GHOST */
    #drag-ghost {
        position: fixed; width: 65px; height: 65px; pointer-events: none; z-index: 9999;
        display: none; opacity: 0.9; transform: translate(-50%, -50%);
        background: rgba(50,50,50,0.9); border: 2px solid #76ff03; border-radius: 6px;
        align-items: center; justify-content: center;
    }
    #drag-ghost .slot-icon { font-size: 32px; }

    /* NOTIFICATIONS */
    #notify-area { position: absolute; bottom: 130px; right: 20px; display: flex; flex-direction: column; gap: 5px; align-items: flex-end; z-index: 30; }
    .note { background: rgba(20,20,20,0.95); color: #fff; padding: 10px 20px; border-right: 4px solid #76ff03; font-weight: bold; animation: fadeOut 3s forwards; box-shadow: 0 2px 5px black; }
    @keyframes fadeOut { 0% {opacity:1;} 80% {opacity:1;} 100% {opacity:0;} }

    /* START BTN */
    #start-screen { position: absolute; top:0; left:0; width:100%; height:100%; background: #111; z-index: 200; display: flex; flex-direction: column; justify-content: center; align-items: center; pointer-events: auto; }
    .btn { padding: 20px 60px; font-size: 24px; background: #76ff03; border: none; font-weight: bold; cursor: pointer; border-radius: 5px; transition: 0.2s; }
    .btn:hover { transform: scale(1.05); background: #fff; }
</style>
</head>
<body>

<canvas id="cvs"></canvas>

<div id="drag-ghost"><div class="slot-icon"></div></div>

<div id="start-screen">
    <h1 style="color:#76ff03; font-size:80px; margin:0;">RUST 2D</h1>
    <p style="color:#aaa; font-size:20px; margin-bottom: 30px;">STABLE EDITION</p>
    <button class="btn" onclick="startGame()">–ò–ì–†–ê–¢–¨</button>
</div>

<div id="ui-layer" style="display:none;">
    <div id="notify-area"></div>
    <div id="hud">
        <div class="bar"><div class="fill" id="hp-bar" style="background:#d32f2f; width:100%"></div><span class="bar-text">HP</span></div>
        <div class="bar"><div class="fill" id="food-bar" style="background:#f57c00; width:100%"></div><span class="bar-text">FOOD</span></div>
    </div>
    <div id="hotbar"></div> 
</div>

<div id="game-menu" class="menu-overlay">
    <div class="panel">
        <div>
            <h3>–†–Æ–ö–ó–ê–ö</h3>
            <div class="inv-grid" id="inv-grid"></div>
        </div>
        <div style="border-left:1px solid #555; padding-left:20px;">
            <h3>–ö–†–ê–§–¢</h3>
            <div class="craft-list" id="craft-list"></div>
        </div>
    </div>
</div>

<script>
/* --- CONFIG --- */
const cvs = document.getElementById('cvs');
const ctx = cvs.getContext('2d');
const W_MAP = 3000, H_MAP = 3000;
const X_WATER = 400;

/* --- ITEMS DB --- */
const ITEMS = {
    rock: { name: '–ö–∞–º–µ–Ω—å', icon: 'ü™®', type: 'tool', dmg: 10, bonus: 'rock' },
    axe: { name: '–¢–æ–ø–æ—Ä', icon: 'ü™ì', type: 'tool', dmg: 25, bonus: 'tree' },
    pickaxe: { name: '–ö–∏—Ä–∫–∞', icon: '‚õèÔ∏è', type: 'tool', dmg: 25, bonus: 'rock' },
    hammer: { name: '–ö–∏—è–Ω–∫–∞', icon: 'üî®', type: 'tool', dmg: 5 },
    
    wood: { name: '–î–µ—Ä–µ–≤–æ', icon: 'üå≤', type: 'res' },
    stone: { name: '–†—É–¥–∞', icon: 'üåë', type: 'res' },
    iron_ore: { name: '–ñ–µ–ª. –†—É–¥–∞', icon: 'ü™®', type: 'res' }, // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –≤–∏–∑—É–∞–ª
    sulfur_ore: { name: '–°–µ—Ä–∞', icon: 'üü°', type: 'res' },
    metal_frags: { name: '–§—Ä–∞–≥–º–µ–Ω—Ç—ã', icon: 'üî©', type: 'res' },
    scrap: { name: '–°–∫—Ä–∞–ø', icon: '‚öôÔ∏è', type: 'comp' },
    cloth: { name: '–¢–∫–∞–Ω—å', icon: 'üß∂', type: 'comp' },
    leather: { name: '–ö–æ–∂–∞', icon: 'ü•ì', type: 'comp' },
    fat: { name: '–ñ–∏—Ä', icon: 'ü•©', type: 'comp' },

    bow: { name: '–õ—É–∫', icon: 'üèπ', type: 'weapon', dmg: 35 },
    ak: { name: 'AK-47', icon: 'üî´', type: 'weapon', dmg: 15, auto: true },
    
    box: { name: '–Ø—â–∏–∫', icon: 'üì¶', type: 'deploy' },
    furnace: { name: '–ü–µ—á—å', icon: 'üî•', type: 'deploy' },
    wb1: { name: '–í–µ—Ä—Å—Ç–∞–∫ 1', icon: 'üõ†Ô∏è', type: 'deploy' },
    
    plan: { name: '–ü–ª–∞–Ω', icon: 'üìÑ', type: 'build' },
    door_wood: { name: '–î–≤–µ—Ä—å (–î)', icon: 'üö™', type: 'deploy_door' },
    wall_wood: { name: '–°—Ç–µ–Ω–∞ (–î)', icon: 'üß±', type: 'deploy_wall' },

    food: { name: '–ï–¥–∞', icon: 'ü•´', type: 'food', val: 30 }
};

const RECIPES = [
    { id: 'axe', cost: { wood: 100, stone: 50 } },
    { id: 'pickaxe', cost: { wood: 100, stone: 50 } },
    { id: 'hammer', cost: { wood: 100 } },
    { id: 'plan', cost: { wood: 20 } },
    { id: 'door_wood', cost: { wood: 300 } },
    { id: 'wall_wood', cost: { wood: 200 } },
    { id: 'box', cost: { wood: 100 } },
    { id: 'furnace', cost: { stone: 200, wood: 100, fat: 20 } },
    { id: 'wb1', cost: { wood: 500, scrap: 50 } },
    { id: 'bow', cost: { wood: 200, cloth: 50 } },
    { id: 'ak', cost: { metal_frags: 200, wood: 100, scrap: 50 } },
    { id: 'metal_frags', name:'–ü–µ—Ä–µ–ø–ª–∞–≤–∫–∞', cost: { iron_ore: 1, wood: 5 }, out: 1 },
];

/* --- STATE --- */
let player = { x: 600, y: 1500, hp: 100, food: 100, angle: 0, inv: Array(24).fill(null), belt: Array(6).fill(null), beltIdx: 0 };
let world = { entities: [], static: [], roads: [] };
let cam = { x:0, y:0 };
let input = { w:0, a:0, s:0, d:0, mx:0, my:0 };
let gameTime = 0;
let dragObj = { active: false, item: null, fromIdx: -1, fromType: null };

/* --- GAME ENGINE --- */
function startGame() {
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('ui-layer').style.display = 'block';
    resize();

    if(!player.belt[0]) addItem('rock', 1);
    if(!player.belt[1]) addItem('food', 3);

    generateWorld();
    updateUI();
    loop();
}

function generateWorld() {
    world.entities = [];
    world.static = [];
    world.roads = [];

    // 1. –î–æ—Ä–æ–≥–∞
    let rx = 1500;
    for(let y=0; y<H_MAP; y+=20) {
        rx += Math.sin(y*0.003)*10;
        let finalX = Math.max(600, Math.min(W_MAP-600, rx + 1500)); 
        world.roads.push({x:finalX, y:y});
    }

    // 2. –†–µ—Å—É—Ä—Å—ã (–ë–µ–∑ –†–¢)
    for(let i=0; i<500; i++) {
        let x = X_WATER + Math.random()*(W_MAP-X_WATER);
        let y = Math.random()*H_MAP;
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Ä–æ–≥–∏
        let onRoad = false;
        for(let r of world.roads) if(Math.abs(r.y - y) < 20 && Math.abs(r.x - x) < 100) onRoad = true;
        if(onRoad) continue;

        let type = 'tree';
        let r = Math.random();
        if(r > 0.75) type = (Math.random()>0.5 ? 'stone' : 'iron');
        if(r > 0.95) type = 'sulfur';

        let hp = type==='tree'?30:50;
        world.entities.push({x, y, type, hp, scale: 0.8+Math.random()*0.4});
    }

    // 3. –ë–æ—á–∫–∏ (–Ω–∞ –¥–æ—Ä–æ–≥–µ)
    for(let i=0; i<world.roads.length; i+=20) {
        if(Math.random() < 0.2) {
            let p = world.roads[i];
            world.entities.push({x:p.x+(Math.random()-0.5)*50, y:p.y, type:'barrel', hp:10});
        }
    }

    // 4. –û–ª–µ–Ω–∏
    for(let i=0; i<25; i++) {
        world.entities.push({
            x: Math.random()*W_MAP, y: Math.random()*H_MAP, 
            type: 'deer', hp: 40, angle: Math.random()*6.28, speed: 0
        });
    }
}

function loop() {
    gameTime += 0.05;
    update();
    draw();
    requestAnimationFrame(loop);
}

function update() {
    // FIX BLACK SCREEN BUG
    if(isNaN(player.x) || isNaN(player.y)) { player.x = 600; player.y = 1500; }

    let speed = 4;
    let dx = (input.d - input.a) * speed;
    let dy = (input.s - input.w) * speed;
    if(dx||dy) {
        player.x = Math.max(X_WATER+20, Math.min(W_MAP, player.x + dx));
        player.y = Math.max(0, Math.min(H_MAP, player.y + dy));
    }
    player.angle = Math.atan2(input.my - cvs.height/2, input.mx - cvs.width/2);
    cam.x = player.x - cvs.width/2;
    cam.y = player.y - cvs.height/2;

    // AI
    world.entities.forEach(e => {
        if(e.type === 'deer') {
            if(e.speed > 0) {
                e.x += Math.cos(e.angle)*e.speed;
                e.y += Math.sin(e.angle)*e.speed;
                e.speed *= 0.96;
                if(e.x < X_WATER) e.angle = 0; 
            } else if(Math.random() < 0.01) { 
                e.angle += (Math.random()-0.5); e.speed = 1.5; 
            }
        }
    });
}

function draw() {
    // Clear
    ctx.setTransform(1,0,0,1,0,0);
    ctx.fillStyle = '#111'; ctx.fillRect(0,0,cvs.width, cvs.height);
    
    ctx.translate(-cam.x, -cam.y);

    // Water & Land
    ctx.fillStyle = '#1565c0'; ctx.fillRect(cam.x, cam.y, cvs.width, cvs.height); // Background water
    ctx.fillStyle = '#33691e'; ctx.fillRect(X_WATER, 0, W_MAP, H_MAP); // Land

    // Waves edge
    ctx.fillStyle = '#42a5f5'; 
    ctx.beginPath();
    for(let y=cam.y; y<cam.y+cvs.height; y+=20) {
        let x = X_WATER + Math.sin(y*0.02 + gameTime)*10;
        ctx.lineTo(x, y);
    }
    ctx.lineTo(X_WATER-50, cam.y+cvs.height);
    ctx.lineTo(X_WATER-50, cam.y);
    ctx.fill();

    // Road
    if(world.roads.length > 0) {
        ctx.lineWidth = 80; ctx.strokeStyle = '#555'; ctx.lineCap='round'; ctx.lineJoin='round';
        ctx.beginPath(); ctx.moveTo(world.roads[0].x, world.roads[0].y);
        for(let p of world.roads) ctx.lineTo(p.x, p.y);
        ctx.stroke();
        
        ctx.lineWidth = 2; ctx.strokeStyle = '#777'; ctx.setLineDash([20,20]); ctx.stroke(); ctx.setLineDash([]);
    }

    // Objects
    let list = [...world.entities, {type:'player', y:player.y}];
    list.sort((a,b)=>a.y - b.y);

    list.forEach(e => {
        if(e.type==='player') drawPlayer();
        else drawEntity(e);
    });
}

function drawEntity(e) {
    if(e.shake) { ctx.save(); ctx.translate(Math.random()*4-2, 0); e.shake--; }

    // –¢–µ–Ω—å (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ —á–µ—Ä–Ω—ã—Ö –∫—Ä—É–≥–æ–≤)
    ctx.fillStyle = 'rgba(0,0,0,0.2)'; 
    ctx.beginPath(); ctx.ellipse(e.x, e.y+5, 15*(e.scale||1), 7, 0, 0, 6.28); ctx.fill();

    if(e.type === 'tree') {
        let s = e.scale || 1;
        ctx.fillStyle = '#4e342e'; ctx.fillRect(e.x-5*s, e.y-10*s, 10*s, 20*s);
        ctx.fillStyle = '#1b5e20';
        ctx.beginPath(); ctx.moveTo(e.x-30*s, e.y-5*s); ctx.lineTo(e.x, e.y-60*s); ctx.lineTo(e.x+30*s, e.y-5*s); ctx.fill();
        ctx.fillStyle = '#2e7d32';
        ctx.beginPath(); ctx.moveTo(e.x-25*s, e.y-30*s); ctx.lineTo(e.x, e.y-80*s); ctx.lineTo(e.x+25*s, e.y-30*s); ctx.fill();
    }
    else if(e.type.includes('stone') || e.type.includes('iron') || e.type.includes('sulfur')) {
        // –ü—Ä–æ—Å—Ç–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞–º–Ω–µ–π –±–µ–∑ –±–∞–≥–æ–≤
        let color = '#9e9e9e'; // Stone
        if(e.type === 'iron') color = '#5d4037'; // Brown
        if(e.type === 'sulfur') color = '#fbc02d'; // Yellow
        
        ctx.fillStyle = color;
        ctx.beginPath(); ctx.arc(e.x, e.y-10, 20*(e.scale||1), 0, 6.28); ctx.fill();
        
        // –ë–ª–∏–∫
        ctx.fillStyle = 'rgba(255,255,255,0.1)';
        ctx.beginPath(); ctx.arc(e.x-5, e.y-20, 8, 0, 6.28); ctx.fill();
    }
    else if(e.type === 'barrel') {
        ctx.fillStyle = '#1565c0'; ctx.beginPath(); ctx.arc(e.x, e.y-15, 15, 0, 6.28); ctx.fill();
        ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.stroke();
    }
    else if(e.type === 'deer') {
        ctx.fillStyle = '#795548';
        ctx.save(); ctx.translate(e.x, e.y); ctx.rotate(e.angle);
        ctx.fillRect(-15, -8, 30, 16); 
        ctx.beginPath(); ctx.arc(15, 0, 8, 0, 6.28); ctx.fill(); 
        ctx.strokeStyle = '#d7ccc8'; ctx.lineWidth=2;
        ctx.beginPath(); ctx.moveTo(15,-2); ctx.lineTo(25,-10); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(15,2); ctx.lineTo(25,10); ctx.stroke();
        ctx.restore();
    }

    if(e.shake) ctx.restore();
}

function drawPlayer() {
    ctx.save(); ctx.translate(player.x, player.y); ctx.rotate(player.angle);
    ctx.fillStyle = '#ffcc80'; ctx.beginPath(); ctx.arc(0, 0, 14, 0, 6.28); ctx.fill();
    ctx.fillStyle = '#333'; ctx.beginPath(); ctx.arc(0, 0, 11, 0, 6.28); ctx.fill();
    ctx.fillStyle = '#ffcc80'; 
    ctx.beginPath(); ctx.arc(12, 12, 5, 0, 6.28); ctx.fill();
    ctx.beginPath(); ctx.arc(12, -12, 5, 0, 6.28); ctx.fill();
    
    let h = player.belt[player.beltIdx];
    if(h) {
        ctx.fillStyle = '#fff'; ctx.font = '20px serif'; ctx.fillText(ITEMS[h.id].icon, 15, 8);
    }
    ctx.restore();
}

/* --- LOGIC --- */
window.onmousedown = (e) => {
    if(e.button === 0) {
        let slot = e.target.closest('.slot');
        if(slot) return startDrag(e, slot);
        if(e.target.closest('.panel')) return;

        // Attack
        let wx = cam.x + e.clientX, wy = cam.y + e.clientY;
        let hand = player.belt[player.beltIdx];
        
        world.entities.forEach((ent, i) => {
            if(Math.hypot(ent.x-wx, ent.y-wy) < 50 && Math.hypot(player.x-ent.x, player.y-ent.y) < 200) {
                let dmg = (hand && ITEMS[hand.id].dmg) || 5;
                if(hand && ITEMS[hand.id].bonus === ent.type) dmg *= 2;
                
                ent.hp -= dmg; ent.shake = 10;
                if(ent.type === 'deer') { ent.speed = 5; ent.angle = Math.atan2(ent.y-player.y, ent.x-player.x); }

                if(ent.hp <= 0) {
                    world.entities.splice(i, 1);
                    if(ent.type==='tree') addItem('wood', 50);
                    if(ent.type==='stone') addItem('stone', 30);
                    if(ent.type==='iron') addItem('iron_ore', 20);
                    if(ent.type==='sulfur') addItem('sulfur_ore', 20);
                    if(ent.type==='barrel') { addItem('scrap', 2); addItem('comp', 1); }
                    if(ent.type==='deer') { addItem('leather', 2); addItem('fat', 2); addItem('food', 3); }
                }
            }
        });
    }
}

/* --- DRAG & DROP --- */
function startDrag(e, slot) {
    let parent = slot.parentElement;
    let isBelt = parent.id === 'hotbar';
    let idx = Array.from(parent.children).indexOf(slot);
    let arr = isBelt ? player.belt : player.inv;
    
    if(!arr[idx]) return;

    dragObj = { active: true, item: arr[idx], fromIdx: idx, fromType: isBelt?'belt':'inv' };
    
    let g = document.getElementById('drag-ghost');
    g.querySelector('.slot-icon').innerText = ITEMS[arr[idx].id].icon;
    g.style.display = 'flex';
    g.style.left = e.clientX+'px'; g.style.top = e.clientY+'px';
}

window.onmousemove = e => {
    input.mx = e.clientX; input.my = e.clientY;
    if(dragObj.active) {
        let g = document.getElementById('drag-ghost');
        g.style.left = e.clientX+'px'; g.style.top = e.clientY+'px';
    }
}

window.onmouseup = e => {
    if(dragObj.active) {
        let slot = e.target.closest('.slot');
        if(slot) {
            let parent = slot.parentElement;
            let isBelt = parent.id === 'hotbar';
            let toIdx = Array.from(parent.children).indexOf(slot);
            let fromArr = dragObj.fromType=='belt'?player.belt:player.inv;
            let toArr = isBelt?player.belt:player.inv;
            
            let tmp = toArr[toIdx];
            toArr[toIdx] = fromArr[dragObj.fromIdx];
            fromArr[dragObj.fromIdx] = tmp;
        }
        dragObj.active = false;
        document.getElementById('drag-ghost').style.display = 'none';
        updateUI();
    }
}

/* --- INVENTORY --- */
function addItem(id, count) {
    let txt = `+${count} ${ITEMS[id].name}`;
    for(let arr of [player.belt, player.inv]) {
        for(let s of arr) if(s && s.id==id) { s.count+=count; notify(txt); updateUI(); return; }
    }
    for(let i=0; i<6; i++) if(!player.belt[i]) { player.belt[i]={id,count}; notify(txt); updateUI(); return; }
    for(let i=0; i<24; i++) if(!player.inv[i]) { player.inv[i]={id,count}; notify(txt); updateUI(); return; }
    notify("–ù–µ—Ç –º–µ—Å—Ç–∞");
}

function notify(t) {
    let d = document.createElement('div'); d.className='note'; d.innerText=t;
    document.getElementById('notify-area').appendChild(d);
    setTimeout(()=>d.remove(), 3000);
}

function updateUI() {
    let hb = document.getElementById('hotbar'); hb.innerHTML='';
    player.belt.forEach((s,i)=>renderSlot(hb, s, i, true));
    
    let inv = document.getElementById('inv-grid'); inv.innerHTML='';
    player.inv.forEach((s,i)=>renderSlot(inv, s, i, false));

    let cl = document.getElementById('craft-list'); cl.innerHTML='';
    RECIPES.forEach(r => {
        let d = document.createElement('div'); d.className='craft-row';
        let cost = Object.keys(r.cost).map(k=>`${ITEMS[k].icon}${r.cost[k]}`).join(' ');
        d.innerHTML = `<span>${ITEMS[r.id].name}</span><span class="craft-req">${cost}</span>`;
        d.onclick = () => {
            for(let k in r.cost) if(count(k)<r.cost[k]) return notify("–ù–∞–¥–æ —Ä–µ—Å—É—Ä—Å—ã");
            for(let k in r.cost) take(k, r.cost[k]);
            addItem(r.id, r.out||1);
        };
        cl.appendChild(d);
    });
}

function renderSlot(p, item, idx, isBelt) {
    let d = document.createElement('div'); d.className='slot';
    if(isBelt && idx===player.beltIdx) d.classList.add('active');
    if(item) d.innerHTML = `<div class="slot-icon">${ITEMS[item.id].icon}</div><div class="slot-count">${item.count}</div>`;
    p.appendChild(d);
}

function count(id) { let c=0; [...player.belt, ...player.inv].forEach(s=>{if(s&&s.id==id)c+=s.count}); return c; }
function take(id, n) {
    let l=n;
    [player.belt, player.inv].forEach(arr=>{
        arr.forEach((s,i)=>{
            if(l>0 && s && s.id==id) { let t=Math.min(l,s.count); s.count-=t; l-=t; if(s.count<=0) arr[i]=null; }
        });
    });
    updateUI();
}

window.onkeydown = e => {
    if(e.code=='KeyW') input.w=1; if(e.code=='KeyS') input.s=1;
    if(e.code=='KeyA') input.a=1; if(e.code=='KeyD') input.d=1;
    if(e.code=='KeyE') {
        let m = document.getElementById('game-menu');
        m.style.display = m.style.display=='flex'?'none':'flex';
    }
    if(e.key>='1' && e.key<='6') { player.beltIdx = parseInt(e.key)-1; updateUI(); }
};
window.onkeyup = e => { if(e.code=='KeyW') input.w=0; if(e.code=='KeyS') input.s=0; if(e.code=='KeyA') input.a=0; if(e.code=='KeyD') input.d=0; };
function resize() { cvs.width = window.innerWidth; cvs.height = window.innerHeight; }
window.onresize = resize;
</script>
</body>
</html>
