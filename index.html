<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Rust 2D: Building Update</title>
<style>
    body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; user-select: none; }
    canvas { display: block; }

    /* UI Layers */
    #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
    .pointer { pointer-events: auto; }

    /* HUD */
    #hud { position: absolute; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 8px; z-index: 101; }
    .bar { width: 250px; height: 25px; background: rgba(0,0,0,0.8); border: 1px solid #555; border-radius: 4px; overflow: hidden; position: relative; }
    .fill { height: 100%; transition: width 0.2s; }
    .bar-text { position: absolute; right: 10px; top: 0; font-size: 14px; color: white; font-weight: bold; line-height: 25px; text-shadow: 1px 1px 1px #000; }

    /* HOTBAR */
    #hotbar { 
        position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); 
        display: flex; gap: 8px; padding: 10px; 
        background: rgba(30,30,30,0.9); border-radius: 10px; border: 1px solid #555; 
        pointer-events: auto; z-index: 101;
    }
    .slot { 
        width: 70px; height: 70px; 
        background: rgba(50,50,50,0.5); border: 2px solid #555; 
        color: white; display: flex; flex-direction: column; align-items: center; justify-content: center;
        cursor: pointer; position: relative; border-radius: 4px; transition: 0.1s;
    }
    .slot:hover { background: rgba(80,80,80,0.8); border-color: #fff; }
    .slot.active { border-color: #76ff03; box-shadow: 0 0 15px rgba(118,255,3,0.3); transform: translateY(-4px); }
    .slot-icon { font-size: 32px; filter: drop-shadow(0 2px 2px black); pointer-events: none; }
    .slot-count { position: absolute; bottom: 2px; right: 4px; font-weight: bold; font-size: 14px; pointer-events: none; }

    /* BUILDING MENU (RADIAL STYLE) */
    #build-menu {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 300px; height: 300px; border-radius: 50%;
        background: rgba(0,0,0,0.8); border: 2px solid #76ff03;
        display: none; z-index: 999; pointer-events: auto;
    }
    .build-opt {
        position: absolute; width: 70px; height: 70px; background: #333; border-radius: 50%;
        display: flex; align-items: center; justify-content: center; font-size: 30px;
        border: 2px solid #555; cursor: pointer; color: white; transition: 0.2s;
        box-shadow: 0 5px 10px black;
    }
    .build-opt:hover { background: #76ff03; color: black; transform: scale(1.1); }
    /* Positioning */
    .b-top { top: 10px; left: 115px; } /* Wall */
    .b-right { top: 115px; left: 220px; } /* Doorway */
    .b-bot { bottom: 10px; left: 115px; } /* Foundation */
    .b-left { top: 115px; left: 10px; } /* Triangle */
    .b-center { top: 115px; left: 115px; background: #555; font-size: 12px; } /* Close */

    /* NOTIFICATIONS */
    #notify-area { position: absolute; bottom: 130px; right: 20px; display: flex; flex-direction: column; gap: 5px; align-items: flex-end; }
    .note { background: rgba(20,20,20,0.9); color: #fff; padding: 10px 20px; border-right: 4px solid #76ff03; font-weight: bold; animation: fadeOut 3s forwards; }
    @keyframes fadeOut { 0% {opacity:1;} 90% {opacity:1;} 100% {opacity:0;} }

    /* INVENTORY & START */
    .menu-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); display:none; justify-content:center; align-items:center; z-index:200; pointer-events:auto; }
    .panel { background:#2b2b2b; border:1px solid #555; padding:30px; display:flex; gap:30px; border-radius:8px; }
    .inv-grid { display:grid; grid-template-columns:repeat(6,1fr); gap:8px; }
    #start-screen { position:absolute; top:0; left:0; width:100%; height:100%; background:#111; z-index:500; display:flex; flex-direction:column; justify-content:center; align-items:center; pointer-events:auto; }
    .btn { padding:20px 60px; font-size:24px; background:#76ff03; border:none; font-weight:bold; cursor:pointer; border-radius:5px; }
    
    /* DRAG GHOST */
    #drag-ghost { position:fixed; width:70px; height:70px; pointer-events:none; z-index:9999; display:none; opacity:0.9; background:rgba(40,40,40,0.8); border:2px solid #76ff03; border-radius:4px; align-items:center; justify-content:center; font-size:32px; color:white; }
    
    /* Craft List */
    .craft-list { width:300px; height:400px; overflow-y:auto; background:rgba(0,0,0,0.2); }
    .craft-row { display:flex; justify-content:space-between; padding:8px; background:#383838; margin:5px; cursor:pointer; border:1px solid #444; }
    .craft-row:hover { background:#555; }
</style>
</head>
<body>

<canvas id="cvs"></canvas>

<div id="drag-ghost"></div>

<div id="start-screen">
    <h1 style="color:#76ff03; font-size:80px; margin:0;">RUST 2D</h1>
    <p style="color:#aaa; font-size:20px;">BUILDING UPDATE</p>
    <br>
    <button class="btn" onclick="startGame()">–ò–ì–†–ê–¢–¨</button>
</div>

<div id="ui-layer" style="display:none;">
    <div id="notify-area"></div>
    <div id="hud">
        <div class="bar"><div class="fill" id="hp-bar" style="background:#d32f2f; width:100%"></div><span class="bar-text">HP</span></div>
        <div class="bar"><div class="fill" id="food-bar" style="background:#f57c00; width:100%"></div><span class="bar-text">FOOD</span></div>
        <div id="build-info" style="color: #76ff03; text-align: right; margin-top: 5px; font-weight: bold;"></div>
    </div>
    <div id="hotbar"></div> 
</div>

<div id="build-menu">
    <div class="build-opt b-top" onclick="selectBuild('wall')" title="–°—Ç–µ–Ω–∞">üß±</div>
    <div class="build-opt b-right" onclick="selectBuild('doorway')" title="–ü—Ä–æ–µ–º">üö™</div>
    <div class="build-opt b-bot" onclick="selectBuild('foundation')" title="–§—É–Ω–¥–∞–º–µ–Ω—Ç">‚¨õ</div>
    <div class="build-opt b-left" onclick="selectBuild('tri_foundation')" title="–¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫">üî∫</div>
    <div class="build-opt b-center" onclick="toggleBuildMenu()">‚ùå</div>
</div>

<div id="game-menu" class="menu-overlay">
    <div class="panel">
        <div><h3>–†–Æ–ö–ó–ê–ö</h3><div class="inv-grid" id="inv-grid"></div></div>
        <div style="border-left:1px solid #555; padding-left:20px;"><h3>–ö–†–ê–§–¢</h3><div class="craft-list" id="craft-list"></div></div>
    </div>
</div>

<script>
/* CONFIG */
const cvs = document.getElementById('cvs');
const ctx = cvs.getContext('2d');
const W_MAP = 3000, H_MAP = 3000, X_WATER = 400;

/* DB */
const ITEMS = {
    rock: { name: '–ö–∞–º–µ–Ω—å', icon: 'ü™®', type: 'tool', dmg: 10, bonus: 'rock' },
    axe: { name: '–¢–æ–ø–æ—Ä', icon: 'ü™ì', type: 'tool', dmg: 25, bonus: 'tree' },
    pickaxe: { name: '–ö–∏—Ä–∫–∞', icon: '‚õèÔ∏è', type: 'tool', dmg: 25, bonus: 'rock' },
    hammer: { name: '–ö–∏—è–Ω–∫–∞', icon: 'üî®', type: 'tool', dmg: 5 },
    plan: { name: '–ü–ª–∞–Ω', icon: 'üìÑ', type: 'build' },
    
    wood: { name: '–î–µ—Ä–µ–≤–æ', icon: 'üå≤', type: 'res' },
    stone: { name: '–†—É–¥–∞', icon: 'üåë', type: 'res' },
    iron_ore: { name: '–ñ–µ–ª. –†—É–¥–∞', icon: 'ü™®', type: 'res' },
    sulfur_ore: { name: '–°–µ—Ä–∞', icon: 'üü°', type: 'res' },
    metal_frags: { name: '–§—Ä–∞–≥–º–µ–Ω—Ç—ã', icon: 'üî©', type: 'res' },
    scrap: { name: '–°–∫—Ä–∞–ø', icon: '‚öôÔ∏è', type: 'comp' },
    cloth: { name: '–¢–∫–∞–Ω—å', icon: 'üß∂', type: 'comp' },
    fat: { name: '–ñ–∏—Ä', icon: 'ü•©', type: 'comp' },

    bow: { name: '–õ—É–∫', icon: 'üèπ', type: 'weapon', dmg: 35 },
    ak: { name: 'AK-47', icon: 'üî´', type: 'weapon', dmg: 15, auto: true },
    
    box: { name: '–Ø—â–∏–∫', icon: 'üì¶', type: 'deploy' },
    furnace: { name: '–ü–µ—á—å', icon: 'üî•', type: 'deploy' },
    wb1: { name: '–í–µ—Ä—Å—Ç–∞–∫ 1', icon: 'üõ†Ô∏è', type: 'deploy' },
    door_wood: { name: '–î–≤–µ—Ä—å (–î)', icon: 'üö™', type: 'deploy_door' },
    
    food: { name: '–ï–¥–∞', icon: 'ü•´', type: 'food', val: 30 }
};

const RECIPES = [
    { id: 'axe', cost: { wood: 100, stone: 50 } },
    { id: 'pickaxe', cost: { wood: 100, stone: 50 } },
    { id: 'hammer', cost: { wood: 100 } },
    { id: 'plan', cost: { wood: 20 } },
    { id: 'door_wood', cost: { wood: 300 } },
    { id: 'box', cost: { wood: 100 } },
    { id: 'furnace', cost: { stone: 200, wood: 100, fat: 20 } },
    { id: 'wb1', cost: { wood: 500, scrap: 50 } },
    { id: 'bow', cost: { wood: 200, cloth: 50 } },
    { id: 'ak', cost: { metal_frags: 200, wood: 100, scrap: 50 } },
    { id: 'metal_frags', name:'–ü–µ—Ä–µ–ø–ª–∞–≤–∏—Ç—å', cost: { iron_ore: 1, wood: 5 }, out: 1 },
];

/* BUILD SYSTEM */
let currentBuild = 'foundation'; // Default
const BUILD_COSTS = {
    'foundation': { wood: 20, type: 'floor', w: 50, h: 50 },
    'tri_foundation': { wood: 15, type: 'floor_tri', w: 50, h: 50 },
    'wall': { wood: 20, type: 'wall', w: 50, h: 50 },
    'doorway': { wood: 15, type: 'doorway', w: 50, h: 50 }
};

/* STATE */
let player = { x: 600, y: 1500, hp: 100, food: 100, angle: 0, inv: Array(24).fill(null), belt: Array(6).fill(null), beltIdx: 0 };
let world = { entities: [], static: [], roads: [], roofs: [] };
let cam = { x:0, y:0 };
let input = { w:0, a:0, s:0, d:0, mx:0, my:0 };
let gameTime = 0;
let dragObj = { active: false, item: null, fromIdx: -1, fromType: null };

/* INIT */
function startGame() {
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('ui-layer').style.display = 'block';
    resize();
    if(!player.belt[0]) addItem('rock', 1);
    generateWorld();
    updateUI();
    loop();
}

function generateWorld() {
    world.entities = []; world.static = []; world.roads = []; world.roofs = [];
    // Roads
    let rx = 1500;
    for(let y=0; y<H_MAP; y+=20) {
        rx += Math.sin(y*0.003)*10 + (Math.random()-0.5)*2;
        if(rx < 600) rx=600; if(rx > W_MAP-600) rx=W_MAP-600;
        world.roads.push({x:rx, y:y});
    }
    // Monuments
    createMonument(world.roads[20].x - 300, 400, "Supermarket");
    createMonument(world.roads[100].x + 250, 2000, "Gas Station");
    // Resources
    for(let i=0; i<600; i++) {
        let x = X_WATER + Math.random()*(W_MAP-X_WATER);
        let y = Math.random()*H_MAP;
        let onRoad = false;
        for(let j=0; j<world.roads.length; j+=20) if(Math.hypot(x-world.roads[j].x, y-world.roads[j].y) < 120) onRoad=true;
        if(onRoad) continue;
        let type = 'tree'; let r = Math.random();
        if(r > 0.7) type = (Math.random()>0.5 ? 'stone' : 'iron');
        if(r > 0.95) type = 'sulfur';
        let hp = type==='tree'?30:50;
        world.entities.push({x, y, type, hp, seed: Math.random()*100, scale: 0.8+Math.random()*0.4});
    }
    // Barrels
    for(let i=0; i<world.roads.length; i+=15) if(Math.random() < 0.15) world.entities.push({x:world.roads[i].x+(Math.random()-0.5)*50, y:world.roads[i].y, type:'barrel', hp:10});
    // Deer
    for(let i=0; i<30; i++) world.entities.push({x: Math.random()*W_MAP, y: Math.random()*H_MAP, type: 'deer', hp: 40, angle: Math.random()*6.28, speed: 0});
}

function createMonument(x, y, name) {
    let w = 400, h = 300, t=15;
    world.static.push({x, y, w, h, type:'floor', collidable: false});
    world.static.push({x, y, w, h:t, type:'wall', collidable: true});
    world.static.push({x, y:y+h-t, w, h:t, type:'wall', collidable: true});
    world.static.push({x, y, w:t, h, type:'wall', collidable: true});
    world.static.push({x:x+w-t, y, w:t, h, type:'wall', collidable: true});
    world.entities.push({x:x+50, y:y+50, type:'barrel', hp:10});
    world.entities.push({x:x+w-50, y:y+h-50, type:'crate', hp:20});
    world.roofs.push({x, y, w, h, name});
}

function loop() { gameTime += 0.05; update(); draw(); requestAnimationFrame(loop); }

function update() {
    let speed = 4;
    let dx = (input.d - input.a) * speed;
    let dy = (input.s - input.w) * speed;
    
    // Prediction
    let nx = player.x + dx, ny = player.y + dy;
    
    // Collision Player vs Static
    let pRect = {x: nx-10, y: ny-10, w: 20, h: 20};
    let collides = false;
    for(let s of world.static) {
        if(s.collidable && rectIntersect(pRect, s)) collides = true;
    }
    
    if(!collides) {
        player.x = Math.max(X_WATER+20, Math.min(W_MAP, nx));
        player.y = Math.max(0, Math.min(H_MAP, ny));
    }
    
    player.angle = Math.atan2(input.my - cvs.height/2, input.mx - cvs.width/2);
    cam.x = player.x - cvs.width/2; cam.y = player.y - cvs.height/2;

    // Deer AI
    world.entities.forEach(e => {
        if(e.type === 'deer') {
            if(e.speed > 0) {
                e.x += Math.cos(e.angle)*e.speed; e.y += Math.sin(e.angle)*e.speed; e.speed *= 0.96;
                if(e.x < X_WATER) e.angle = 0;
            } else if(Math.random() < 0.01) { e.angle += (Math.random()-0.5); e.speed = 1.5; }
        }
    });

    // Update UI info
    let hand = player.belt[player.beltIdx];
    let info = document.getElementById('build-info');
    if(hand && hand.id === 'plan') info.innerText = "Build: " + currentBuild.toUpperCase() + " [F]";
    else info.innerText = "";
}

function rectIntersect(r1, r2) {
    return !(r2.x > r1.x + r1.w || r2.x + r2.w < r1.x || r2.y > r1.y + r1.h || r2.y + r2.h < r1.y);
}

function draw() {
    ctx.setTransform(1,0,0,1,0,0); ctx.fillStyle = '#111'; ctx.fillRect(0,0,cvs.width, cvs.height);
    ctx.translate(-cam.x, -cam.y);

    // Water/Land
    ctx.fillStyle = '#1565c0'; ctx.fillRect(cam.x, cam.y, cvs.width, cvs.height);
    ctx.fillStyle = '#33691e'; ctx.fillRect(X_WATER, 0, W_MAP, H_MAP);
    
    // Road
    if(world.roads.length > 0) {
        ctx.lineWidth = 90; ctx.strokeStyle = '#555'; ctx.lineCap='round'; ctx.lineJoin='round';
        ctx.beginPath(); ctx.moveTo(world.roads[0].x, world.roads[0].y);
        for(let p of world.roads) ctx.lineTo(p.x, p.y);
        ctx.stroke();
    }

    // Static Objects (Floors FIRST)
    world.static.forEach(s => {
        if(s.type.includes('floor')) { ctx.fillStyle='#222'; ctx.fillRect(s.x, s.y, s.w, s.h); ctx.strokeStyle='#333'; ctx.strokeRect(s.x, s.y, s.w, s.h); }
    });

    // Entities & Walls
    let list = [...world.entities, {type:'player', y:player.y}];
    world.static.forEach(s => { if(s.type==='wall' || s.type==='doorway') list.push({type:'wall', obj:s, y:s.y+s.h}); });
    list.sort((a,b)=>a.y - b.y);

    list.forEach(e => {
        if(e.type==='player') drawPlayer();
        else if(e.type==='wall') { 
            let o = e.obj;
            ctx.fillStyle=o.type==='doorway'?'#444':'#5d4037'; 
            ctx.fillRect(o.x, o.y, o.w, o.h); 
            ctx.strokeStyle='#111'; ctx.strokeRect(o.x, o.y, o.w, o.h);
            if(o.type==='doorway') { ctx.fillStyle='#000'; ctx.fillRect(o.x+15, o.y+5, 20, 45); }
        }
        else drawEntity(e);
    });

    // Roofs
    world.roofs.forEach(r => {
        if(Math.hypot(player.x-(r.x+r.w/2), player.y-(r.y+r.h/2)) > 250) {
            ctx.fillStyle = '#1a1a1a'; ctx.fillRect(r.x, r.y, r.w, r.h);
        }
    });
}

function drawEntity(e) {
    if(e.shake) { ctx.save(); ctx.translate(Math.random()*4-2, 0); e.shake--; }
    ctx.fillStyle = 'rgba(0,0,0,0.3)'; ctx.beginPath(); ctx.ellipse(e.x, e.y+5, 15*(e.scale||1), 6, 0, 0, 6.28); ctx.fill();

    if(e.type === 'tree') {
        let s = e.scale || 1;
        ctx.fillStyle = '#3e2723'; ctx.fillRect(e.x-5*s, e.y-10*s, 10*s, 20*s);
        ctx.fillStyle = '#1b5e20'; ctx.beginPath(); ctx.moveTo(e.x-30*s, e.y-5*s); ctx.lineTo(e.x, e.y-60*s); ctx.lineTo(e.x+30*s, e.y-5*s); ctx.fill();
        ctx.fillStyle = '#2e7d32'; ctx.beginPath(); ctx.moveTo(e.x-25*s, e.y-30*s); ctx.lineTo(e.x, e.y-80*s); ctx.lineTo(e.x+25*s, e.y-30*s); ctx.fill();
    }
    else if(e.type.includes('stone') || e.type.includes('iron') || e.type.includes('sulfur')) {
        let c = e.type==='iron'?'#5d4037':(e.type==='sulfur'?'#fbc02d':'#9e9e9e');
        ctx.fillStyle = c; ctx.beginPath();
        for(let i=0; i<7; i++) { let a = (i/7)*6.28; let r = 20 + Math.sin(e.seed + i)*8; ctx.lineTo(e.x + Math.cos(a)*r, e.y-10 + Math.sin(a)*r); }
        ctx.fill(); ctx.stroke();
    }
    else if(e.type === 'barrel') { ctx.fillStyle = '#1565c0'; ctx.beginPath(); ctx.arc(e.x, e.y-15, 15, 0, 6.28); ctx.fill(); ctx.stroke(); }
    else if(e.type === 'crate') { ctx.fillStyle = '#795548'; ctx.fillRect(e.x-20, e.y-20, 40, 40); ctx.strokeRect(e.x-20, e.y-20, 40, 40); }
    else if(e.type === 'deer') {
        ctx.fillStyle = '#795548'; ctx.save(); ctx.translate(e.x, e.y); ctx.rotate(e.angle);
        ctx.fillRect(-15, -8, 30, 16); ctx.beginPath(); ctx.arc(15, 0, 8, 0, 6.28); ctx.fill();
        ctx.strokeStyle='#d7ccc8'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(15,-2); ctx.lineTo(25,-10); ctx.stroke(); ctx.beginPath(); ctx.moveTo(15,2); ctx.lineTo(25,10); ctx.stroke();
        ctx.restore();
    }
    if(e.shake) ctx.restore();
}

function drawPlayer() {
    ctx.save(); ctx.translate(player.x, player.y); ctx.rotate(player.angle);
    ctx.fillStyle = '#ffcc80'; ctx.beginPath(); ctx.arc(0, 0, 14, 0, 6.28); ctx.fill();
    ctx.fillStyle = '#333'; ctx.beginPath(); ctx.arc(0, 0, 11, 0, 6.28); ctx.fill();
    ctx.fillStyle = '#ffcc80'; ctx.beginPath(); ctx.arc(12, 12, 5, 0, 6.28); ctx.fill(); ctx.beginPath(); ctx.arc(12, -12, 5, 0, 6.28); ctx.fill();
    let h = player.belt[player.beltIdx];
    if(h) { ctx.fillStyle = '#fff'; ctx.font = '20px sans-serif'; ctx.fillText(ITEMS[h.id].icon, 20, 5); }
    ctx.restore();
}

/* INTERACTION */
window.onmousedown = (e) => {
    if(e.button !== 0) return;
    if(e.target.closest('.slot')) return startDrag(e, e.target.closest('.slot'));
    if(e.target.closest('.panel') || e.target.closest('#build-menu')) return;

    let wx = cam.x + e.clientX, wy = cam.y + e.clientY;
    let hand = player.belt[player.beltIdx];

    // BUILDING LOGIC
    if(hand && hand.id === 'plan') {
        // Grid snap
        let bx = Math.floor(wx/50)*50;
        let by = Math.floor(wy/50)*50;
        let cost = BUILD_COSTS[currentBuild];
        
        // Check overlap
        let blocked = false;
        for(let s of world.static) if(s.x === bx && s.y === by) blocked = true;
        
        if(!blocked && count('wood') >= cost.wood) {
            take('wood', cost.wood);
            world.static.push({x:bx, y:by, w:cost.w, h:cost.h, type:cost.type, collidable: cost.type !== 'floor' && cost.type !== 'floor_tri'});
            notify("–ü–æ—Å—Ç—Ä–æ–µ–Ω–æ: " + currentBuild);
        } else if(blocked) notify("–ó–∞–Ω—è—Ç–æ!");
        else notify("–ù–∞–¥–æ " + cost.wood + " –¥–µ—Ä–µ–≤–∞");
        return;
    }

    // ATTACK/GATHER
    world.entities.forEach((ent, i) => {
        if(Math.hypot(ent.x-wx, ent.y-wy) < 50 && Math.hypot(player.x-ent.x, player.y-ent.y) < 200) {
            let dmg = (hand && ITEMS[hand.id].dmg) || 5;
            if(hand && ITEMS[hand.id].bonus === ent.type) dmg *= 2;
            ent.hp -= dmg; ent.shake = 10;
            if(ent.type === 'deer') { ent.speed = 5; ent.angle = Math.atan2(ent.y-player.y, ent.x-player.x); }
            if(ent.hp <= 0) {
                world.entities.splice(i, 1);
                if(ent.type==='tree') addItem('wood', 50);
                if(ent.type==='stone') addItem('stone', 30);
                if(ent.type==='iron') addItem('iron_ore', 15);
                if(ent.type==='sulfur') addItem('sulfur_ore', 15);
                if(ent.type==='barrel') { addItem('scrap', 2); addItem('comp', 1); }
                if(ent.type==='crate') { addItem('scrap', 10); addItem('metal_frags', 5); }
                if(ent.type==='deer') { addItem('leather', 3); addItem('fat', 2); addItem('food', 4); }
            }
        }
    });
}

/* UI LOGIC */
function toggleBuildMenu() {
    let bm = document.getElementById('build-menu');
    bm.style.display = bm.style.display === 'block' ? 'none' : 'block';
}
function selectBuild(type) {
    currentBuild = type;
    toggleBuildMenu();
}

/* DRAG & DROP */
function startDrag(e, slot) {
    let parent = slot.parentElement;
    let isBelt = parent.id === 'hotbar';
    let idx = Array.from(parent.children).indexOf(slot);
    let arr = isBelt ? player.belt : player.inv;
    let item = arr[idx];
    if(!item) return;
    dragObj = { active: true, item, fromIdx: idx, fromType: isBelt?'belt':'inv' };
    let g = document.getElementById('drag-ghost');
    g.innerText = ITEMS[item.id].icon; g.style.display = 'flex';
    g.style.left = e.clientX+'px'; g.style.top = e.clientY+'px';
}
window.onmousemove = e => {
    input.mx = e.clientX; input.my = e.clientY;
    if(dragObj.active) { let g = document.getElementById('drag-ghost'); g.style.left=e.clientX+'px'; g.style.top=e.clientY+'px'; }
}
window.onmouseup = e => {
    if(dragObj.active) {
        let slot = e.target.closest('.slot');
        if(slot) {
            let parent = slot.parentElement;
            let isBelt = parent.id === 'hotbar';
            let toIdx = Array.from(parent.children).indexOf(slot);
            let fromArr = dragObj.fromType=='belt'?player.belt:player.inv;
            let toArr = isBelt?player.belt:player.inv;
            let tmp = toArr[toIdx];
            toArr[toIdx] = fromArr[dragObj.fromIdx];
            fromArr[dragObj.fromIdx] = tmp;
        }
        dragObj.active = false; document.getElementById('drag-ghost').style.display='none';
        updateUI();
    }
}

/* INV & CRAFT HELPERS */
function addItem(id, count) {
    let txt = `+${count} ${ITEMS[id].name}`;
    for(let arr of [player.belt, player.inv]) for(let s of arr) if(s && s.id==id) { s.count+=count; notify(txt); updateUI(); return; }
    for(let i=0; i<6; i++) if(!player.belt[i]) { player.belt[i]={id,count}; notify(txt); updateUI(); return; }
    for(let i=0; i<24; i++) if(!player.inv[i]) { player.inv[i]={id,count}; notify(txt); updateUI(); return; }
    notify("–ù–µ—Ç –º–µ—Å—Ç–∞!");
}
function notify(t) { let d=document.createElement('div'); d.className='note'; d.innerText=t; document.getElementById('notify-area').appendChild(d); setTimeout(()=>d.remove(),3000); }
function updateUI() {
    let hb=document.getElementById('hotbar'); hb.innerHTML=''; player.belt.forEach((s,i)=>renderSlot(hb,s,i,true));
    let inv=document.getElementById('inv-grid'); inv.innerHTML=''; player.inv.forEach((s,i)=>renderSlot(inv,s,i,false));
    let cl=document.getElementById('craft-list'); cl.innerHTML='';
    RECIPES.forEach(r=>{
        let d=document.createElement('div'); d.className='craft-row';
        let cost=Object.keys(r.cost).map(k=>`${ITEMS[k].icon}${r.cost[k]}`).join(' ');
        d.innerHTML=`<span>${ITEMS[r.id].name}</span><span class="craft-req">${cost}</span>`;
        d.onclick=()=>{ for(let k in r.cost) if(count(k)<r.cost[k]) return notify("–ù–∞–¥–æ —Ä–µ—Å—É—Ä—Å—ã"); for(let k in r.cost) take(k,r.cost[k]); addItem(r.id,r.out||1); };
        cl.appendChild(d);
    });
}
function renderSlot(p, item, idx, isBelt) {
    let d=document.createElement('div'); d.className='slot'; if(isBelt&&idx===player.beltIdx) d.classList.add('active');
    if(item) d.innerHTML=`<div class="slot-icon">${ITEMS[item.id].icon}</div><div class="slot-count">${item.count}</div>`;
    p.appendChild(d);
}
function count(id) { let c=0; [...player.belt,...player.inv].forEach(s=>{if(s&&s.id==id)c+=s.count}); return c; }
function take(id, n) { let l=n; [player.belt,player.inv].forEach(arr=>{ arr.forEach((s,i)=>{ if(l>0&&s&&s.id==id){ let t=Math.min(l,s.count); s.count-=t; l-=t; if(s.count<=0) arr[i]=null; }}); }); updateUI(); }

/* INPUT */
window.onkeydown = e => {
    if(e.code=='KeyW') input.w=1; if(e.code=='KeyS') input.s=1; if(e.code=='KeyA') input.a=1; if(e.code=='KeyD') input.d=1;
    if(e.code=='KeyE') { let m=document.getElementById('game-menu'); m.style.display=m.style.display=='flex'?'none':'flex'; }
    if(e.code=='KeyF') { 
        let hand = player.belt[player.beltIdx];
        if(hand && hand.id === 'plan') toggleBuildMenu();
        else notify("–ù—É–∂–µ–Ω –ü–ª–∞–Ω (Plan)");
    }
    if(e.key>='1' && e.key<='6') { player.beltIdx=parseInt(e.key)-1; updateUI(); }
};
window.onkeyup = e => { if(e.code=='KeyW') input.w=0; if(e.code=='KeyS') input.s=0; if(e.code=='KeyA') input.a=0; if(e.code=='KeyD') input.d=0; };
function resize() { cvs.width=window.innerWidth; cvs.height=window.innerHeight; }
window.onresize=resize;
</script>
</body>
</html>
