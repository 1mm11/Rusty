<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>Rust 2D: Complete Edition</title>
<style>
    body { margin: 0; overflow: hidden; background: #111; font-family: 'Segoe UI', sans-serif; user-select: none; }
    canvas { display: block; }

    /* UI Layers */
    #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
    .pointer { pointer-events: auto; }

    /* HUD */
    #hud { position: absolute; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 8px; }
    .bar { width: 220px; height: 24px; background: rgba(0,0,0,0.8); border: 1px solid #555; border-radius: 4px; overflow: hidden; position: relative; box-shadow: 0 2px 5px black; }
    .fill { height: 100%; transition: width 0.2s; box-shadow: inset 0 -2px 0 rgba(0,0,0,0.3); }
    .bar-text { position: absolute; right: 8px; top: 0; font-size: 14px; color: white; font-weight: bold; line-height: 24px; text-shadow: 1px 1px 2px #000; }

    /* Hotbar */
    #hotbar { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; padding: 8px; background: rgba(0,0,0,0.6); border-radius: 10px; border: 1px solid #444; }
    .slot { 
        width: 60px; height: 60px; background: rgba(40,40,40,0.9); border: 2px solid #555; 
        color: white; display: flex; flex-direction: column; align-items: center; justify-content: center;
        font-size: 10px; cursor: pointer; position: relative; transition: 0.1s; border-radius: 4px;
    }
    .slot:hover { background: rgba(60,60,60,1); border-color: #aaa; }
    .slot.active { border-color: #76ff03; box-shadow: 0 0 15px rgba(118, 255, 3, 0.4); transform: translateY(-2px); }
    .slot-icon { font-size: 30px; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5)); }
    .slot-count { position: absolute; bottom: 2px; right: 4px; font-weight: bold; font-size: 13px; color: #eee; text-shadow: 1px 1px 0 #000; }

    /* Menus */
    .menu-overlay { 
        position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); 
        display: none; justify-content: center; align-items: center; z-index: 50; pointer-events: auto;
    }
    .panel { 
        background: #282828; border: 1px solid #444; padding: 25px; color: #eee; border-radius: 8px; 
        box-shadow: 0 20px 50px rgba(0,0,0,0.9); display: flex; gap: 30px; max-height: 80vh;
    }
    
    /* Inventory Grid */
    .inv-container { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; }

    /* Crafting */
    .craft-section { width: 350px; display: flex; flex-direction: column; }
    .tabs { display: flex; gap: 5px; margin-bottom: 10px; }
    .tab { padding: 8px 12px; background: #444; cursor: pointer; border-radius: 4px; font-size: 13px; flex: 1; text-align: center; border: 1px solid #555; }
    .tab:hover { background: #555; }
    .tab.active-tab { background: #76ff03; color: #000; font-weight: bold; border-color: #76ff03; }

    .craft-list { overflow-y: auto; flex: 1; padding-right: 5px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 4px; }
    .craft-row { 
        display: flex; align-items: center; justify-content: space-between; background: #383838; 
        margin-bottom: 6px; padding: 8px; cursor: pointer; border: 1px solid #444; border-radius: 4px;
    }
    .craft-row:hover { background: #4a4a4a; border-color: #999; }
    .craft-row.locked { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

    /* Dragging Ghost Item */
    #drag-ghost {
        position: fixed; width: 60px; height: 60px; pointer-events: none; z-index: 999;
        display: none; opacity: 0.9; transform: translate(-50%, -50%);
    }
    #drag-ghost .slot { border-color: #76ff03; background: #333; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }

    /* Notifications */
    #notify-area { position: absolute; bottom: 120px; right: 20px; display: flex; flex-direction: column; gap: 5px; align-items: flex-end; }
    .note { background: rgba(20,20,20,0.9); color: #fff; padding: 8px 15px; border-right: 4px solid #76ff03; font-size: 16px; border-radius: 4px 0 0 4px; animation: fadeOut 4s forwards; box-shadow: 0 2px 5px black; }
    @keyframes fadeOut { 0% {opacity:1; transform: translateX(0);} 80% {opacity:1;} 100% {opacity:0; transform: translateX(20px);} }
</style>
</head>
<body>

<canvas id="cvs"></canvas>

<div id="drag-ghost"></div>

<div id="start-screen" class="menu-overlay" style="display: flex;">
    <div style="text-align: center;">
        <h1 style="color: #76ff03; font-size: 80px; margin: 0; text-shadow: 0 0 30px rgba(118, 255, 3, 0.5);">RUST 2D</h1>
        <p style="color: #bbb; font-size: 20px; letter-spacing: 2px;">SURVIVAL EVOLVED</p>
        <div style="margin-top: 40px; display: flex; gap: 20px; justify-content: center;">
            <button onclick="initGame(false)" style="padding: 15px 40px; font-size: 20px; background: #76ff03; border: none; font-weight: bold; cursor: pointer; border-radius: 5px;">–ü–†–û–î–û–õ–ñ–ò–¢–¨</button>
            <button onclick="initGame(true)" style="padding: 15px 40px; font-size: 20px; background: #444; color: white; border: none; font-weight: bold; cursor: pointer; border-radius: 5px;">–ù–û–í–ê–Ø –ò–ì–†–ê</button>
        </div>
    </div>
</div>

<div id="ui-layer">
    <div id="notify-area"></div>
    
    <div id="hud">
        <div class="bar"><div class="fill" id="hp-bar" style="background:#e53935; width:100%"></div><span class="bar-text">HP</span></div>
        <div class="bar"><div class="fill" id="food-bar" style="background:#fb8c00; width:100%"></div><span class="bar-text">HUNGER</span></div>
    </div>
    
    <div id="hotbar" class="pointer"></div>
</div>

<div id="game-menu" class="menu-overlay">
    <div class="panel">
        <div>
            <h3 style="margin-top:0; color:#ddd; border-bottom: 2px solid #76ff03; padding-bottom: 10px;">–†–Æ–ö–ó–ê–ö</h3>
            <div class="inv-container" id="inv-grid"></div>
        </div>
        <div class="craft-section" style="border-left: 1px solid #444; padding-left: 30px;">
            <h3 style="margin-top:0; color:#ddd; border-bottom: 2px solid #76ff03; padding-bottom: 10px;">–ö–†–ê–§–¢</h3>
            <div class="tabs" id="craft-tabs"></div>
            <div class="craft-list" id="craft-list"></div>
        </div>
    </div>
</div>

<script>
/**
 * --- CONFIG ---
 */
const cvs = document.getElementById('cvs');
const ctx = cvs.getContext('2d');
const W_MAP = 3000;
const H_MAP = 3000;
const X_WATER = 400;

// Items DB
const ITEMS = {
    rock: { name: '–ö–∞–º—ñ–Ω—å', icon: 'ü™®', type: 'tool', dmg: 10, bonus: 'rock' },
    wood: { name: '–î–µ—Ä–µ–≤–æ', icon: 'üå≤', type: 'res' },
    stone: { name: '–†—É–¥–∞', icon: 'üåë', type: 'res' }, // Custom visual
    iron_ore: { name: '–ó–∞–ª—ñ–∑–Ω–∞ —Ä—É–¥–∞', icon: 'ü™®', type: 'res' }, // Custom visual
    sulfur_ore: { name: '–°—ñ—Ä–∫–∞', icon: 'üü°', type: 'res' },
    metal_frags: { name: '–ó–∞–ª—ñ–∑–æ', icon: 'üî©', type: 'res' },
    hqm: { name: '–ú–í–ö', icon: '‚¨ú', type: 'res' },
    scrap: { name: '–°–∫—Ä–∞–ø', icon: '‚öôÔ∏è', type: 'comp' },
    cloth: { name: '–¢–∫–∞–Ω–∏–Ω–∞', icon: 'üß∂', type: 'comp' },
    fat: { name: '–ñ–∏—Ä', icon: 'ü•©', type: 'comp' },
    leather: { name: '–ö–æ–∂–∞', icon: 'ü•ì', type: 'comp' },
    
    // Tools
    axe: { name: '–°–æ–∫–∏—Ä–∞', icon: 'ü™ì', type: 'tool', dmg: 25, bonus: 'tree' },
    pickaxe: { name: '–ö–∏—Ä–∫–∞', icon: '‚õèÔ∏è', type: 'tool', dmg: 25, bonus: 'rock' },
    hammer: { name: '–ö–∏—è–Ω–∫–∞', icon: 'üî®', type: 'tool', dmg: 5 },
    plan: { name: 'Plan', icon: 'üìÑ', type: 'build' },
    
    // Weapons
    bow: { name: '–õ—É–∫', icon: 'üèπ', type: 'weapon', dmg: 30, range: 300 },
    ak: { name: 'AK-47', icon: 'üî´', type: 'weapon', dmg: 15, range: 500, auto: true },
    
    // Deployables
    box: { name: '–Ø—â–∏–∫', icon: 'üì¶', type: 'deploy', w:40, h:40, hp:100 },
    furnace: { name: '–ü—ñ—á', icon: 'üî•', type: 'deploy', w:40, h:40, hp:200 },
    wb1: { name: '–í–µ—Ä—Å—Ç–∞–∫ 1', icon: 'üõ†Ô∏è', type: 'deploy', w:60, h:60, hp:300, wb:1 },
    wb2: { name: '–í–µ—Ä—Å—Ç–∞–∫ 2', icon: 'üóúÔ∏è', type: 'deploy', w:60, h:60, hp:500, wb:2 },
    wb3: { name: '–í–µ—Ä—Å—Ç–∞–∫ 3', icon: 'ü¶æ', type: 'deploy', w:60, h:60, hp:1000, wb:3 },
    
    // Building
    door_wood: { name: '–î–≤–µ—Ä—ñ (–î–µ—Ä)', icon: 'üö™', type: 'build_part' },
    door_metal: { name: '–î–≤–µ—Ä—ñ (–ó–∞–ª)', icon: 'üö™', type: 'build_part' },

    food: { name: '–á–∂–∞', icon: 'ü•´', type: 'food', val: 30 }
};

// FULL RECIPES RESTORED
const CATEGORIES = { tool: '–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏', build: '–ë—É–¥—ñ–≤–Ω–∏—Ü—Ç–≤–æ', weapon: '–ó–±—Ä–æ—è', res: '–†–µ—Å—É—Ä—Å–∏' };
const RECIPES = [
    // Tools
    { id: 'axe', cat: 'tool', cost: { wood: 100, stone: 50 } },
    { id: 'pickaxe', cat: 'tool', cost: { wood: 100, stone: 50 } },
    { id: 'hammer', cat: 'tool', cost: { wood: 100 } },
    { id: 'plan', cat: 'tool', cost: { wood: 20 } },
    
    // Build / Placeable
    { id: 'door_wood', cat: 'build', cost: { wood: 300 } },
    { id: 'door_metal', cat: 'build', cost: { metal_frags: 150, wood: 50 }, wb: 1 },
    { id: 'box', cat: 'build', cost: { wood: 100 } },
    { id: 'furnace', cat: 'build', cost: { stone: 200, wood: 100, fat: 30 } },
    { id: 'wb1', cat: 'build', cost: { wood: 500, scrap: 50 } },
    { id: 'wb2', cat: 'build', cost: { wood: 500, metal_frags: 100, scrap: 250 }, wb: 1 },
    { id: 'wb3', cat: 'build', cost: { metal_frags: 1000, hqm: 50, scrap: 1250 }, wb: 2 },
    
    // Weapons
    { id: 'bow', cat: 'weapon', cost: { wood: 200, cloth: 50 } },
    { id: 'ak', cat: 'weapon', cost: { metal_frags: 400, wood: 200, scrap: 100 }, wb: 2 },
    
    // Resources
    { id: 'metal_frags', cat: 'res', name: '–ü–µ—Ä–µ–ø–ª–∞–≤–∫–∞ (–ü—ñ—á)', cost: { iron_ore: 1, wood: 5 }, reqStation: 'furnace', out: 1 },
    { id: 'leather', cat: 'res', name: '–¢–∫–∞–Ω–∏–Ω–∞', cost: { cloth: 10 }, out: 1 } // Example
];

// State
let player = { x: 800, y: 1500, hp: 100, food: 100, angle: 0, inv: Array(24).fill(null), belt: Array(6).fill(null), beltIdx: 0 };
let world = { entities: [], static: [] };
let cam = { x:0, y:0 };
let input = { w:0, a:0, s:0, d:0, mx:0, my:0 };
let gameLoopId;
let gameTime = 0;
let dragObj = { item: null, fromIdx: -1, fromType: null, active: false }; // Drag State

/**
 * --- INIT ---
 */
function initGame(newGame) {
    document.getElementById('start-screen').style.display = 'none';
    resize();
    if(newGame) generateWorld(); 
    else loadGame();
    
    // Starter kit
    if(!player.belt[0]) addItem('rock', 1);

    updateUI();
    startGameLoop();
}

function generateWorld() {
    world.entities = [];
    
    // Resources
    for(let i=0; i<600; i++) {
        let x = X_WATER + 200 + Math.random()*(W_MAP - X_WATER - 200);
        let y = Math.random()*H_MAP;
        
        let type = 'tree';
        let r = Math.random();
        if(r > 0.7) type = 'stone';
        if(r > 0.85) type = 'iron';
        if(r > 0.95) type = 'sulfur';

        let hp = type==='tree'?30:50;
        // Generate a random seed for rock shape
        let seed = Math.random() * 1000;
        world.entities.push({x, y, type, hp, id:seed, scale: 0.8+Math.random()*0.4});
    }

    // Animals
    for(let i=0; i<40; i++) {
        world.entities.push({
            x: X_WATER + 300 + Math.random()*(W_MAP-600),
            y: Math.random()*H_MAP,
            type: 'deer', hp: 40, angle: Math.random()*6.28, speed: 0, state: 'idle'
        });
    }

    // Barrels
    for(let i=0; i<50; i++) {
        world.entities.push({
            x: X_WATER + 100 + Math.random()*(W_MAP-200),
            y: Math.random()*H_MAP,
            type: 'barrel', hp: 10
        });
    }

    player.x = X_WATER + 200; player.y = H_MAP/2;
}

function startGameLoop() {
    if(gameLoopId) cancelAnimationFrame(gameLoopId);
    loop();
}

function loop() {
    gameTime += 0.05;
    update();
    draw();
    gameLoopId = requestAnimationFrame(loop);
}

/**
 * --- LOGIC ---
 */
function update() {
    let speed = 4;
    let dx = (input.d - input.a) * speed;
    let dy = (input.s - input.w) * speed;
    if(dx||dy) {
        player.x = Math.max(X_WATER+20, Math.min(W_MAP, player.x + dx));
        player.y = Math.max(0, Math.min(H_MAP, player.y + dy));
    }
    player.angle = Math.atan2(input.my - cvs.height/2, input.mx - cvs.width/2);
    cam.x = player.x - cvs.width/2;
    cam.y = player.y - cvs.height/2;

    // Deer AI
    world.entities.forEach(e => {
        if(e.type === 'deer') {
            if(e.state === 'run' && e.speed > 0) {
                e.speed *= 0.98;
                if(e.speed < 0.5) e.state = 'idle';
            } else {
                if(Math.random() < 0.01) { e.angle += (Math.random()-0.5) * 2; e.speed = 1.5; }
                if(e.speed > 0) e.speed *= 0.95;
            }
            let nx = e.x + Math.cos(e.angle)*e.speed;
            let ny = e.y + Math.sin(e.angle)*e.speed;
            if(nx < X_WATER + 50) { e.angle = 0 + (Math.random()-0.5); e.speed = 3; nx = e.x+2; }
            e.x = Math.max(X_WATER+50, Math.min(W_MAP, nx));
            e.y = Math.max(0, Math.min(H_MAP, ny));
        }
    });
}

/**
 * --- RENDER ---
 */
function draw() {
    ctx.setTransform(1,0,0,1,0,0);
    ctx.fillStyle = '#111'; ctx.fillRect(0,0,cvs.width, cvs.height);
    ctx.translate(-cam.x, -cam.y);

    // Water
    ctx.fillStyle = '#1565c0'; 
    ctx.beginPath(); ctx.moveTo(cam.x, cam.y);
    for(let y=cam.y; y<cam.y+cvs.height; y+=20) {
        let x = X_WATER + Math.sin(y*0.01 + gameTime)*15;
        ctx.lineTo(x, y);
    }
    ctx.lineTo(cam.x, cam.y+cvs.height);
    ctx.fill();

    // Grass
    ctx.fillStyle = '#33691e'; ctx.fillRect(X_WATER, 0, W_MAP, H_MAP);

    // Objects
    let list = [...world.entities, {type:'player', y:player.y}];
    list.sort((a,b) => a.y - b.y);

    list.forEach(e => {
        if(e.type==='player') drawPlayer();
        else drawEntity(e);
    });
}

function drawEntity(e) {
    if(e.shake) { ctx.save(); ctx.translate((Math.random()-0.5)*3, 0); e.shake--; }
    
    // Shadow
    ctx.fillStyle = 'rgba(0,0,0,0.3)';
    ctx.beginPath(); ctx.ellipse(e.x, e.y+5, 15*(e.scale||1), 6*(e.scale||1), 0, 0, 6.28); ctx.fill();

    if(e.type === 'tree') {
        let s = e.scale || 1;
        ctx.fillStyle = '#3e2723'; ctx.fillRect(e.x-4*s, e.y-10*s, 8*s, 15*s);
        ctx.fillStyle = '#1b5e20';
        ctx.beginPath(); ctx.moveTo(e.x-20*s, e.y-5*s); ctx.lineTo(e.x, e.y-40*s); ctx.lineTo(e.x+20*s, e.y-5*s); ctx.fill();
        ctx.fillStyle = '#2e7d32';
        ctx.beginPath(); ctx.moveTo(e.x-18*s, e.y-20*s); ctx.lineTo(e.x, e.y-55*s); ctx.lineTo(e.x+18*s, e.y-20*s); ctx.fill();
        ctx.fillStyle = '#4caf50';
        ctx.beginPath(); ctx.moveTo(e.x-12*s, e.y-40*s); ctx.lineTo(e.x, e.y-70*s); ctx.lineTo(e.x+12*s, e.y-40*s); ctx.fill();
    }
    else if(e.type === 'stone' || e.type === 'iron' || e.type === 'sulfur') {
        // --- NEW ROCK DRAWING LOGIC (Not Balls) ---
        let col = '#9e9e9e'; // Stone
        if(e.type === 'iron') col = '#6d4c41'; // Brownish/Red
        if(e.type === 'sulfur') col = '#fdd835'; // Yellow
        
        ctx.fillStyle = col;
        ctx.strokeStyle = '#444';
        ctx.lineWidth = 2;
        
        ctx.beginPath();
        let r = 20 * (e.scale||1);
        let sides = 7;
        for(let i=0; i<sides; i++) {
            let a = (i/sides) * 6.28;
            // Use ID to make shape static but random-looking
            let offset = Math.sin(e.id + i) * (r*0.3); 
            ctx.lineTo(e.x + Math.cos(a)*(r+offset), e.y-10 + Math.sin(a)*(r+offset));
        }
        ctx.closePath();
        ctx.fill();
        ctx.stroke();

        // Highlight
        ctx.fillStyle = 'rgba(255,255,255,0.1)';
        ctx.beginPath(); ctx.arc(e.x-5, e.y-15, 5, 0, 6.28); ctx.fill();
    }
    else if(e.type === 'barrel') {
        ctx.fillStyle = '#1565c0'; ctx.beginPath(); ctx.arc(e.x, e.y-10, 15, 0, 6.28); ctx.fill();
        ctx.strokeStyle='#111'; ctx.lineWidth=2; ctx.stroke();
    }
    else if(e.type === 'deer') {
        ctx.fillStyle = '#8d6e63';
        ctx.save(); ctx.translate(e.x, e.y); ctx.rotate(e.angle);
        ctx.fillRect(-10, -5, 20, 10); // Body
        ctx.beginPath(); ctx.arc(12, 0, 5, 0, 6.28); ctx.fill(); // Head
        ctx.restore();
    }

    if(e.shake) ctx.restore();
}

function drawPlayer() {
    ctx.save();
    ctx.translate(player.x, player.y);
    ctx.rotate(player.angle);
    ctx.fillStyle = '#ffe0b2'; ctx.beginPath(); ctx.arc(0,0,12,0,6.28); ctx.fill();
    ctx.fillStyle = '#333'; ctx.beginPath(); ctx.arc(0,0,10,0,6.28); ctx.fill();
    ctx.fillStyle = '#ffe0b2';
    ctx.beginPath(); ctx.arc(10, 12, 5, 0, 6.28); ctx.fill();
    ctx.beginPath(); ctx.arc(10, -12, 5, 0, 6.28); ctx.fill();
    let item = player.belt[player.beltIdx];
    if(item) {
        ctx.fillStyle = '#777';
        if(item.id=='ak') { ctx.fillStyle='black'; ctx.fillRect(10, -2, 30, 4); }
        else ctx.fillRect(15, -5, 10, 10);
    }
    ctx.restore();
}

/**
 * --- INVENTORY & DRAG/DROP ---
 */
function updateUI() {
    renderGrid('hotbar', player.belt, 6, 'belt');
    renderGrid('inv-grid', player.inv, 24, 'inv');
    document.getElementById('hp-bar').style.width = player.hp + '%';
    document.getElementById('food-bar').style.width = player.food + '%';
}

function renderGrid(domId, arr, size, type) {
    let container = document.getElementById(domId);
    container.innerHTML = '';
    
    for(let i=0; i<size; i++) {
        let slot = document.createElement('div');
        slot.className = 'slot';
        if(type === 'belt' && i === player.beltIdx) slot.classList.add('active');
        
        let item = arr[i];
        if(item) {
            slot.innerHTML = `<div class="slot-icon">${ITEMS[item.id].icon}</div><div class="slot-count">${item.count}</div>`;
        }

        // Drag Events
        slot.onmousedown = (e) => onSlotDown(e, i, type);
        slot.onmouseup = (e) => onSlotUp(e, i, type);
        
        container.appendChild(slot);
    }
}

// Drag Logic
function onSlotDown(e, idx, type) {
    if(e.button !== 0) return;
    let arr = type === 'belt' ? player.belt : player.inv;
    if(!arr[idx]) return;

    dragObj.active = true;
    dragObj.item = arr[idx];
    dragObj.fromIdx = idx;
    dragObj.fromType = type;
    
    let g = document.getElementById('drag-ghost');
    g.style.display = 'flex';
    g.innerHTML = `<div class="slot active" style="border-color:#fff"><div class="slot-icon">${ITEMS[arr[idx].id].icon}</div></div>`;
    updateGhostPos(e);
}

window.onmousemove = (e) => {
    input.mx = e.clientX; input.my = e.clientY;
    if(dragObj.active) updateGhostPos(e);
};

function updateGhostPos(e) {
    let g = document.getElementById('drag-ghost');
    g.style.left = e.clientX + 'px';
    g.style.top = e.clientY + 'px';
}

function onSlotUp(e, toIdx, toType) {
    if(!dragObj.active) return;
    
    let sourceArr = dragObj.fromType === 'belt' ? player.belt : player.inv;
    let targetArr = toType === 'belt' ? player.belt : player.inv;
    
    let itemA = sourceArr[dragObj.fromIdx]; 
    let itemB = targetArr[toIdx]; 
    
    // Swap
    sourceArr[dragObj.fromIdx] = itemB;
    targetArr[toIdx] = itemA;
    
    stopDrag();
}

window.onmouseup = () => { if(dragObj.active) stopDrag(); };

function stopDrag() {
    dragObj.active = false;
    document.getElementById('drag-ghost').style.display = 'none';
    updateUI();
}

/**
 * --- CRAFTING SYSTEM (RESTORED) ---
 */
function renderCraftTabs() {
    let t = document.getElementById('craft-tabs'); t.innerHTML = '';
    let cats = Object.keys(CATEGORIES);
    
    cats.forEach(k => {
        let b = document.createElement('div'); b.className = 'tab'; b.innerText = CATEGORIES[k];
        b.onclick = () => {
            document.querySelectorAll('.tab').forEach(el=>el.classList.remove('active-tab'));
            b.classList.add('active-tab');
            renderCraftList(k);
        };
        t.appendChild(b);
    });
    // Default open first
    t.children[0].click();
}

function renderCraftList(cat) {
    let l = document.getElementById('craft-list'); l.innerHTML = '';
    
    // Check Stations
    let nearWb = 0; let nearFurnace = false;
    // (Simplification: Assuming always near for UI demo, but you can uncomment check logic)
    
    RECIPES.forEach(r => {
        if(r.cat !== cat) return;
        
        let el = document.createElement('div'); el.className = 'craft-row';
        let item = ITEMS[r.id];
        let reqs = Object.keys(r.cost).map(k => `${ITEMS[k].icon}${r.cost[k]}`).join(' ');
        
        el.innerHTML = `
            <div style="display:flex; align-items:center; gap:10px;">
                <span style="font-size:24px">${item.icon}</span>
                <div>
                    <div style="font-weight:bold; font-size:14px">${item.name}</div>
                    <div style="font-size:11px; color:#aaa">${reqs}</div>
                </div>
            </div>
            <div style="color:#76ff03; font-weight:bold; font-size:12px">CRAFT</div>
        `;

        el.onclick = () => {
            let ok = true;
            for(let k in r.cost) if(countItem(k) < r.cost[k]) ok = false;
            
            if(ok) {
                for(let k in r.cost) takeItem(k, r.cost[k]);
                addItem(r.id, r.out || 1);
                notify("–°–∫—Ä–∞—Ñ—á–µ–Ω–æ: " + item.name);
            } else {
                notify("–ù–µ –≤–∏—Å—Ç–∞—á–∞—î —Ä–µ—Å—É—Ä—Å—ñ–≤!");
            }
        };
        l.appendChild(el);
    });
}

/**
 * --- HELPERS & EVENTS ---
 */
window.onmousedown = (e) => {
    if(dragObj.active || document.getElementById('game-menu').style.display === 'flex') return;
    
    let wx = cam.x + e.clientX; let wy = cam.y + e.clientY;
    let hand = player.belt[player.beltIdx];
    
    world.entities.forEach((ent, i) => {
        if(Math.hypot(ent.x-wx, ent.y-wy) < 30 && Math.hypot(player.x-ent.x, player.y-ent.y) < 150) {
            let dmg = (hand && ITEMS[hand.id].dmg) || 5;
            if(hand && ITEMS[hand.id].bonus === ent.type) dmg *= 2;
            
            ent.hp -= dmg; ent.shake = 10;
            if(ent.type === 'deer') { ent.state = 'run'; ent.speed = 4; ent.angle = Math.atan2(ent.y-player.y, ent.x-player.x); }
            
            if(ent.hp <= 0) {
                world.entities.splice(i, 1);
                if(ent.type==='tree') addItem('wood', 50);
                if(ent.type==='stone') addItem('stone', 30);
                if(ent.type==='iron') addItem('iron_ore', 15);
                if(ent.type==='sulfur') addItem('sulfur_ore', 15);
                if(ent.type==='barrel') { addItem('scrap', 2); addItem('comp', 1); }
                if(ent.type==='deer') { addItem('leather', 2); addItem('fat', 2); addItem('food', 2); }
                notify("–î–æ–±—ã—Ç–æ!");
            }
        }
    });
};

function addItem(id, count) {
    for(let i=0; i<player.belt.length; i++) if(player.belt[i] && player.belt[i].id==id) { player.belt[i].count+=count; updateUI(); return; }
    for(let i=0; i<player.inv.length; i++) if(player.inv[i] && player.inv[i].id==id) { player.inv[i].count+=count; updateUI(); return; }
    for(let i=0; i<player.belt.length; i++) if(!player.belt[i]) { player.belt[i]={id,count}; updateUI(); return; }
    for(let i=0; i<player.inv.length; i++) if(!player.inv[i]) { player.inv[i]={id,count}; updateUI(); return; }
    notify("–Ü–Ω–≤–µ–Ω—Ç–∞—Ä –ø–æ–≤–Ω–∏–π!");
}

function countItem(id) {
    let c = 0;
    [...player.belt, ...player.inv].forEach(s=>{if(s&&s.id==id)c+=s.count});
    return c;
}
function takeItem(id, n) {
    let left=n;
    [player.belt, player.inv].forEach(arr=>{
        arr.forEach((s,i)=>{
            if(left>0 && s && s.id==id) {
                let take = Math.min(left, s.count);
                s.count-=take; left-=take;
                if(s.count<=0) arr[i]=null;
            }
        });
    });
    updateUI();
}

function notify(msg) {
    let d = document.createElement('div'); d.className='note'; d.innerText=msg;
    document.getElementById('notify-area').appendChild(d);
    setTimeout(()=>d.remove(),3000);
}

window.onkeydown = e => {
    if(e.code==='KeyW') input.w=1; if(e.code==='KeyS') input.s=1;
    if(e.code==='KeyA') input.a=1; if(e.code==='KeyD') input.d=1;
    if(e.code==='KeyE') {
        let m = document.getElementById('game-menu');
        m.style.display = (m.style.display==='flex'?'none':'flex');
        if(m.style.display==='flex') renderCraftTabs();
    }
    if(e.key >= '1' && e.key <= '6') { player.beltIdx = parseInt(e.key)-1; updateUI(); }
};
window.onkeyup = e => { if(e.code==='KeyW') input.w=0; if(e.code==='KeyS') input.s=0; if(e.code==='KeyA') input.a=0; if(e.code==='KeyD') input.d=0; };
function resize() { cvs.width = window.innerWidth; cvs.height = window.innerHeight; }
function loadGame() { generateWorld(); }

</script>
</body>
</html>
