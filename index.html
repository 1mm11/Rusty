<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Survival Canvas Game</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #222;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none;
        }

        #gameCanvas {
            display: block;
        }

        /* –Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å (HUD) */
        #ui-layer {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            pointer-events: none; /* –©–æ–± –∫–ª—ñ–∫–∏ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ –∫—Ä—ñ–∑—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
        }

        /* –°—Ç–∞—Ç—É—Å –±–∞—Ä–∏ */
        .bars {
            display: flex;
            gap: 20px;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 20px;
            border-radius: 10px;
            pointer-events: auto;
        }

        .bar-container {
            width: 150px;
            height: 20px;
            background: #444;
            border: 2px solid #fff;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            width: 100%;
            transition: width 0.2s;
        }

        #hp-bar { background: #e74c3c; }
        #hunger-bar { background: #f39c12; }
        
        .label {
            position: absolute;
            top: 0; left: 5px;
            font-size: 12px;
            color: white;
            line-height: 20px;
            font-weight: bold;
            text-shadow: 1px 1px 0 #000;
        }

        /* –Ü–Ω–≤–µ–Ω—Ç–∞—Ä —Ç–∞ –ö—Ä–∞—Ñ—Ç */
        .controls {
            display: flex;
            gap: 10px;
            pointer-events: auto;
        }

        .slot {
            width: 60px;
            height: 60px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #555;
            border-radius: 8px;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 10px;
            text-align: center;
            transition: all 0.1s;
        }

        .slot:hover { background: rgba(255, 255, 255, 0.1); }
        .slot.active { border-color: #f1c40f; box-shadow: 0 0 10px #f1c40f; }
        
        .res-count { font-size: 14px; font-weight: bold; margin-top: 2px; }
        
        .notification {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 0 #000;
            opacity: 0;
            transition: opacity 0.5s;
        }

        /* –ü—ñ–¥–∫–∞–∑–∫–∏ */
        #tooltip {
            position: absolute;
            top: 10px;
            left: 10px;
            color: rgba(255,255,255,0.7);
            font-size: 14px;
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="tooltip">
        WASD: –†—É—Ö | –õ–ö–ú: –î—ñ—è/–ê—Ç–∞–∫–∞/–ë—É–¥—ñ–≤–Ω–∏—Ü—Ç–≤–æ | E: –î–≤–µ—Ä—ñ | 1-6: –í–∏–±—ñ—Ä –ø—Ä–µ–¥–º–µ—Ç–∞
    </div>

    <div id="notification" class="notification">–ü–æ—Ç—Ä—ñ–±–Ω–æ –±—ñ–ª—å—à–µ —Ä–µ—Å—É—Ä—Å—ñ–≤!</div>

    <div id="ui-layer">
        <div class="bars">
            <div class="bar-container">
                <div id="hp-bar" class="bar-fill"></div>
                <span class="label">–ó–¥–æ—Ä–æ–≤'—è</span>
            </div>
            <div class="bar-container">
                <div id="hunger-bar" class="bar-fill"></div>
                <span class="label">–ì–æ–ª–æ–¥</span>
            </div>
        </div>

        <div class="controls">
            <div class="slot" style="cursor: default; border-color: #888;">
                <span>üå≤ –î–µ—Ä–µ–≤–æ</span>
                <span id="res-wood" class="res-count">0</span>
            </div>
            <div class="slot" style="cursor: default; border-color: #888;">
                <span>ü™® –ö–∞–º—ñ–Ω—å</span>
                <span id="res-stone" class="res-count">0</span>
            </div>
            <div class="slot" style="cursor: default; border-color: #888;">
                <span>üçñ –á–∂–∞</span>
                <span id="res-food" class="res-count">0</span>
            </div>

            <div class="slot" id="btn-hand" onclick="selectItem(0)">
                <span>‚úã –†—É–∫–∞</span>
                <span>(–ó–±—ñ—Ä)</span>
            </div>
            <div class="slot" id="btn-axe" onclick="selectItem(1)">
                <span>ü™ì –°–æ–∫–∏—Ä–∞</span>
                <span>10üå≤ 10ü™®</span>
            </div>
            <div class="slot" id="btn-pick" onclick="selectItem(2)">
                <span>‚õèÔ∏è –ö–∏—Ä–∫–∞</span>
                <span>10üå≤ 10ü™®</span>
            </div>
            <div class="slot" id="btn-wall" onclick="selectItem(3)">
                <span>üß± –°—Ç—ñ–Ω–∞</span>
                <span>20üå≤</span>
            </div>
            <div class="slot" id="btn-door" onclick="selectItem(4)">
                <span>üö™ –î–≤–µ—Ä—ñ</span>
                <span>30üå≤</span>
            </div>
            <div class="slot" id="btn-fire" onclick="selectItem(5)">
                <span>üî• –ö–æ—Å—Ç–µ—Ä</span>
                <span>10üå≤ 10ü™®</span>
            </div>
            <div class="slot" id="btn-eat" onclick="eatFood()">
                <span>üçΩÔ∏è –ó'—ó—Å—Ç–∏</span>
                <span>–í—ñ–¥–Ω. –ì–æ–ª–æ–¥</span>
            </div>
        </div>
    </div>

<script>
/**
 * –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –¢–ê –ö–û–ù–°–¢–ê–ù–¢–ò
 */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// –†–æ–∑–º—ñ—Ä–∏ –∫–∞—Ä—Ç–∏
const MAP_WIDTH = 3000;
const MAP_HEIGHT = 3000;
const TILE_SIZE = 50; // –†–æ–∑–º—ñ—Ä —Å—ñ—Ç–∫–∏ –¥–ª—è –±—É–¥—ñ–≤–Ω–∏—Ü—Ç–≤–∞

// –ö–∞–º–µ—Ä–∞
let camera = { x: 0, y: 0 };

// –í–≤–µ–¥–µ–Ω–Ω—è
const keys = {};
let mouse = { x: 0, y: 0, worldX: 0, worldY: 0 };

// –°—Ç–∞–Ω –≥—Ä–∏
let gameTime = 0; // 0 to 2400 (Cycle)
const DAY_LENGTH = 12000; // frames per day

// –ì—Ä–∞–≤–µ—Ü—å
const player = {
    x: MAP_WIDTH / 2,
    y: MAP_HEIGHT / 2,
    radius: 15,
    speed: 4,
    hp: 100,
    maxHp: 100,
    hunger: 100,
    maxHunger: 100,
    inv: { wood: 0, stone: 0, food: 0 },
    equipped: 0, // 0:Hand, 1:Axe, 2:Pickaxe, 3:Wall, 4:Door, 5:Campfire
    tools: { axe: false, pickaxe: false }
};

// –°–ø–∏—Å–∫–∏ –æ–±'—î–∫—Ç—ñ–≤
const entities = []; // –î–µ—Ä–µ–≤–∞, –∫–∞–º—ñ–Ω–Ω—è, –∫—É—â—ñ
const buildings = []; // –°—Ç—ñ–Ω–∏, –¥–≤–µ—Ä—ñ, –∫–æ—Å—Ç—Ä–∏
const waterZones = [];

// –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏ —Ç–∏–ø—ñ–≤
const TYPE_TREE = 'tree';
const TYPE_ROCK = 'rock';
const TYPE_BUSH = 'bush';
const TYPE_WALL = 'wall';
const TYPE_DOOR = 'door';
const TYPE_FIRE = 'fire';

/**
 * –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø
 */
function init() {
    resize();
    window.addEventListener('resize', resize);
    
    // –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è —Å–≤—ñ—Ç—É
    generateWorld();

    // –ü–æ–¥—ñ—ó –≤–≤–µ–¥–µ–Ω–Ω—è
    window.addEventListener('keydown', e => {
        keys[e.code] = true;
        if(e.key >= '1' && e.key <= '6') selectItem(parseInt(e.key) - 1); // 1-based to 0-based
        if(e.code === 'KeyE') interact();
    });
    window.addEventListener('keyup', e => keys[e.code] = false);
    window.addEventListener('mousemove', e => {
        mouse.x = e.clientX;
        mouse.y = e.clientY;
    });
    window.addEventListener('mousedown', onClick);

    // –ó–∞–ø—É—Å–∫ —Ü–∏–∫–ª—É
    requestAnimationFrame(loop);
}

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}

function generateWorld() {
    // 1. –í–æ–¥–∞ (–∫—ñ–ª—å–∫–∞ –≤–µ–ª–∏–∫–∏—Ö –æ–∑–µ—Ä)
    for(let i=0; i<8; i++) {
        waterZones.push({
            x: Math.random() * MAP_WIDTH,
            y: Math.random() * MAP_HEIGHT,
            radius: 100 + Math.random() * 200
        });
    }

    // 2. –†–µ—Å—É—Ä—Å–∏
    for(let i=0; i<400; i++) {
        let type = Math.random();
        let ent = {
            id: Math.random(),
            x: Math.random() * MAP_WIDTH,
            y: Math.random() * MAP_HEIGHT,
            hp: 10,
            maxHp: 10
        };

        if(type < 0.5) { // –î–µ—Ä–µ–≤–æ
            ent.type = TYPE_TREE;
            ent.radius = 20;
            ent.color = '#2ecc71';
            ent.stroke = '#1e8449';
            ent.hp = 15;
        } else if (type < 0.8) { // –ö–∞–º—ñ–Ω—å
            ent.type = TYPE_ROCK;
            ent.radius = 18;
            ent.color = '#95a5a6';
            ent.stroke = '#7f8c8d';
            ent.hp = 20;
        } else { // –ö—É—â
            ent.type = TYPE_BUSH;
            ent.radius = 12;
            ent.color = '#82e0aa';
            ent.stroke = 'none';
            ent.hp = 5;
        }

        // –ù–µ —Å–ø–∞–≤–Ω–∏—Ç–∏ –≤ –≤–æ–¥—ñ –∞–±–æ –Ω–∞ —Å–ø–∞–≤–Ω—ñ
        if (!isInWater(ent.x, ent.y, ent.radius) && dist(ent.x, ent.y, player.x, player.y) > 200) {
            entities.push(ent);
        }
    }
}

/**
 * –ì–û–õ–û–í–ù–ò–ô –¶–ò–ö–õ (UPDATE & DRAW)
 */
function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}

function update() {
    // 1. –î–µ–Ω—å/–ù—ñ—á
    gameTime = (gameTime + 1) % DAY_LENGTH;
    
    // 2. –ì–æ–ª–æ–¥
    if (gameTime % 200 === 0) {
        player.hunger = Math.max(0, player.hunger - 1);
        if(player.hunger === 0) player.hp = Math.max(0, player.hp - 2);
    }
    updateUI();

    // 3. –†—É—Ö –ì—Ä–∞–≤—Ü—è
    let dx = 0;
    let dy = 0;
    if (keys['KeyW']) dy = -player.speed;
    if (keys['KeyS']) dy = player.speed;
    if (keys['KeyA']) dx = -player.speed;
    if (keys['KeyD']) dx = player.speed;

    // –ù–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è –¥—ñ–∞–≥–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ä—É—Ö—É
    if (dx !== 0 && dy !== 0) {
        dx *= 0.707;
        dy *= 0.707;
    }

    // –ü–µ—Ä–µ–¥–±–∞—á–µ–Ω–Ω—è –ø–æ–∑–∏—Ü—ñ—ó –¥–ª—è –∫–æ–ª—ñ–∑—ñ–π
    let nextX = player.x + dx;
    let nextY = player.y + dy;

    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ–ª—ñ–∑—ñ–π
    if (nextX > 0 && nextX < MAP_WIDTH && !checkCollision(nextX, player.y)) {
        player.x = nextX;
    }
    if (nextY > 0 && nextY < MAP_HEIGHT && !checkCollision(player.x, nextY)) {
        player.y = nextY;
    }

    // 4. –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–∞–º–µ—Ä–∏
    camera.x = player.x - canvas.width / 2;
    camera.y = player.y - canvas.height / 2;

    // 5. –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –º–∏—à—ñ —É —Å–≤—ñ—Ç—ñ
    mouse.worldX = mouse.x + camera.x;
    mouse.worldY = mouse.y + camera.y;
}

/**
 * –†–ï–ù–î–ï–†–ò–ù–ì
 */
function draw() {
    // –§–æ–Ω (–ó–µ–º–ª—è)
    ctx.fillStyle = '#d4ac6e'; // –ü—ñ—Å–æ—á–Ω–∏–π/–ó–µ–º–ª—è–Ω–∏–π –∫–æ–ª—ñ—Ä
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.save();
    // –ó—Å—É–≤ –∫–∞–º–µ—Ä–∏
    ctx.translate(-camera.x, -camera.y);

    // –ú–∞–ª—é—î–º–æ —Å—ñ—Ç–∫—É (–ª–µ–¥—å –≤–∏–¥–Ω–æ) –¥–ª—è –∫—Ä–∞—Å–∏
    drawGrid();

    // 1. –í–æ–¥–∞
    waterZones.forEach(w => {
        ctx.beginPath();
        ctx.arc(w.x, w.y, w.radius, 0, Math.PI * 2);
        ctx.fillStyle = '#3498db';
        ctx.fill();
    });

    // 2. –ë—É–¥—ñ–≤–ª—ñ (–°—Ç—ñ–Ω–∏, –ö–æ—Å—Ç—Ä–∏)
    buildings.forEach(b => {
        if(b.type === TYPE_WALL) {
            ctx.fillStyle = '#8d6e63';
            ctx.fillRect(b.x, b.y, b.w, b.h);
            ctx.strokeStyle = '#5d4037';
            ctx.lineWidth = 2;
            ctx.strokeRect(b.x, b.y, b.w, b.h);
        } else if (b.type === TYPE_DOOR) {
            ctx.fillStyle = b.isOpen ? 'rgba(141, 110, 99, 0.3)' : '#a1887f';
            ctx.fillRect(b.x, b.y, b.w, b.h);
            ctx.strokeStyle = '#3e2723';
            ctx.strokeRect(b.x, b.y, b.w, b.h);
        } else if (b.type === TYPE_FIRE) {
            ctx.beginPath();
            ctx.arc(b.x, b.y, 10, 0, Math.PI*2);
            ctx.fillStyle = '#e74c3c';
            ctx.fill();
            // –ê–Ω—ñ–º–∞—Ü—ñ—è –≤–æ–≥–Ω—é
            ctx.beginPath();
            ctx.arc(b.x + (Math.random()-0.5)*5, b.y + (Math.random()-0.5)*5, 7, 0, Math.PI*2);
            ctx.fillStyle = '#f1c40f';
            ctx.fill();
        }
    });

    // 3. –†–µ—Å—É—Ä—Å–∏ (–î–µ—Ä–µ–≤–∞, –ö–∞–º–µ–Ω—ñ)
    entities.forEach(e => {
        ctx.beginPath();
        ctx.arc(e.x, e.y, e.radius, 0, Math.PI * 2);
        ctx.fillStyle = e.color;
        ctx.fill();
        if(e.stroke !== 'none') {
            ctx.lineWidth = 3;
            ctx.strokeStyle = e.stroke;
            ctx.stroke();
        }
        // –ï—Ñ–µ–∫—Ç –ø–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è
        if(e.hp < e.maxHp) {
            ctx.fillStyle = 'red';
            ctx.font = '12px Arial';
            ctx.fillText(e.hp, e.x - 5, e.y);
        }
    });

    // 4. –ì—Ä–∞–≤–µ—Ü—å
    ctx.beginPath();
    ctx.arc(player.x, player.y, player.radius, 0, Math.PI * 2);
    ctx.fillStyle = '#fff';
    ctx.fill();
    ctx.strokeStyle = '#333';
    ctx.lineWidth = 2;
    ctx.stroke();
    // –†—É–∫–∏
    ctx.beginPath();
    ctx.arc(player.x + 12, player.y + 5, 6, 0, Math.PI * 2); // –ü—Ä–∞–≤–∞
    ctx.arc(player.x - 12, player.y + 5, 6, 0, Math.PI * 2); // –õ—ñ–≤–∞
    ctx.fillStyle = '#e0e0e0';
    ctx.fill();
    ctx.stroke();

    // 5. –ü—Ä–∏–≤–∏–¥ –±—É–¥—ñ–≤–Ω–∏—Ü—Ç–≤–∞ (Ghost)
    if(player.equipped >= 3) {
        let ghostX = Math.floor(mouse.worldX / TILE_SIZE) * TILE_SIZE;
        let ghostY = Math.floor(mouse.worldY / TILE_SIZE) * TILE_SIZE;
        let distToPlayer = dist(player.x, player.y, ghostX + TILE_SIZE/2, ghostY + TILE_SIZE/2);
        
        let valid = distToPlayer < 150 && !checkCollisionRect(ghostX, ghostY, TILE_SIZE, TILE_SIZE);
        
        ctx.fillStyle = valid ? 'rgba(46, 204, 113, 0.5)' : 'rgba(231, 76, 60, 0.5)';
        
        // –î–ª—è –∫–æ—Å—Ç—Ä–∞ –º–∞–ª—é—î–º–æ –∫–æ–ª–æ, –¥–ª—è —Å—Ç—ñ–Ω –∫–≤–∞–¥—Ä–∞—Ç
        if (player.equipped === 5) {
             ctx.beginPath();
             ctx.arc(ghostX + TILE_SIZE/2, ghostY + TILE_SIZE/2, 10, 0, Math.PI*2);
             ctx.fill();
        } else {
             ctx.fillRect(ghostX, ghostY, TILE_SIZE, TILE_SIZE);
        }
    }

    ctx.restore();

    // 6. –û—Å–≤—ñ—Ç–ª–µ–Ω–Ω—è (Day/Night)
    drawLighting();
}

function drawGrid() {
    ctx.strokeStyle = 'rgba(0,0,0,0.05)';
    ctx.lineWidth = 1;
    ctx.beginPath();
    // –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è: –º–∞–ª—é—î–º–æ —Ç—ñ–ª—å–∫–∏ –≤ –ø–æ–ª—ñ –∑–æ—Ä—É
    let startX = Math.floor(camera.x / TILE_SIZE) * TILE_SIZE;
    let startY = Math.floor(camera.y / TILE_SIZE) * TILE_SIZE;
    
    for(let x = startX; x < startX + canvas.width + TILE_SIZE; x += TILE_SIZE) {
        ctx.moveTo(x, startY);
        ctx.lineTo(x, startY + canvas.height + TILE_SIZE);
    }
    for(let y = startY; y < startY + canvas.height + TILE_SIZE; y += TILE_SIZE) {
        ctx.moveTo(startX, y);
        ctx.lineTo(startX + canvas.width + TILE_SIZE, y);
    }
    ctx.stroke();
}

function drawLighting() {
    // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —Ç–µ–º—Ä—è–≤–∏ (—Å–∏–Ω—É—Å–æ—ó–¥–∞)
    // 0 = –ù—ñ—á, 1 = –î–µ–Ω—å.
    let cycle = Math.sin((gameTime / DAY_LENGTH) * Math.PI * 2); 
    // –ù–∞–º —Ç—Ä–µ–±–∞: –ù—ñ—á=0.9 opacity, –î–µ–Ω—å=0 opacity
    let darkness = 0;
    if (cycle < 0) { // –ù—ñ—á
        darkness = Math.abs(cycle) * 0.95; 
    }

    if (darkness > 0.05) {
        ctx.fillStyle = `rgba(0, 0, 0, ${darkness})`;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // "–í–∏—Ä—ñ–∑–∞—î–º–æ" —Å–≤—ñ—Ç–ª–æ
        ctx.save();
        ctx.globalCompositeOperation = 'destination-out';

        // –°–≤—ñ—Ç–ª–æ –Ω–∞–≤–∫–æ–ª–æ –≥—Ä–∞–≤—Ü—è
        let grad = ctx.createRadialGradient(
            player.x - camera.x, player.y - camera.y, 10,
            player.x - camera.x, player.y - camera.y, 150
        );
        grad.addColorStop(0, 'rgba(0,0,0,1)');
        grad.addColorStop(1, 'rgba(0,0,0,0)');
        ctx.fillStyle = grad;
        ctx.beginPath();
        ctx.arc(player.x - camera.x, player.y - camera.y, 150, 0, Math.PI*2);
        ctx.fill();

        // –°–≤—ñ—Ç–ª–æ –≤—ñ–¥ –∫–æ—Å—Ç—Ä—ñ–≤
        buildings.forEach(b => {
            if(b.type === TYPE_FIRE) {
                 // –¢—Ä–µ–º–µ—Ä–µ–Ω–Ω—è —Å–≤—ñ—Ç–ª–∞
                 let flick = Math.random() * 5;
                 let screenX = b.x - camera.x;
                 let screenY = b.y - camera.y;
                 if(screenX > -100 && screenX < canvas.width+100 && screenY > -100 && screenY < canvas.height+100) {
                     let fireGrad = ctx.createRadialGradient(screenX, screenY, 10, screenX, screenY, 120 + flick);
                     fireGrad.addColorStop(0, 'rgba(0,0,0,1)');
                     fireGrad.addColorStop(1, 'rgba(0,0,0,0)');
                     ctx.fillStyle = fireGrad;
                     ctx.beginPath();
                     ctx.arc(screenX, screenY, 120 + flick, 0, Math.PI*2);
                     ctx.fill();
                 }
            }
        });

        ctx.restore();
    }
    
    // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –≥–æ–¥–∏–Ω–Ω–∏–∫–∞ (—Ç–µ–∫—Å—Ç)
    ctx.fillStyle = 'white';
    ctx.font = '20px monospace';
    ctx.fillText(darkness > 0.5 ? "üåô –ù—ñ—á" : "‚òÄÔ∏è –î–µ–Ω—å", 20, 40);
}

/**
 * –õ–û–ì–Ü–ö–ê
 */

// –ö–æ–ª—ñ–∑—ñ—ó
function checkCollision(x, y) {
    // –í–æ–¥–∞
    for(let w of waterZones) {
        if(dist(x, y, w.x, w.y) < w.radius) return true;
    }
    // –î–µ—Ä–µ–≤–∞ —ñ –ö–∞–º–µ–Ω—ñ (—Å—É—Ç–Ω–æ—Å—Ç—ñ)
    for(let e of entities) {
        if(dist(x, y, e.x, e.y) < e.radius + player.radius) return true;
    }
    // –°—Ç—ñ–Ω–∏
    for(let b of buildings) {
        if((b.type === TYPE_WALL || (b.type === TYPE_DOOR && !b.isOpen)) &&
           x + player.radius > b.x && x - player.radius < b.x + b.w &&
           y + player.radius > b.y && y - player.radius < b.y + b.h) {
            return true;
        }
    }
    return false;
}

// –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ –≤—ñ–ª—å–Ω–µ –º—ñ—Å—Ü–µ –¥–ª—è –±—É–¥—ñ–≤–Ω–∏—Ü—Ç–≤–∞
function checkCollisionRect(x, y, w, h) {
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫—É—Ç—ñ–≤
    if (checkCollision(x+1, y+1)) return true;
    if (checkCollision(x+w-1, y+h-1)) return true;
    
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ —î –≤–∂–µ –±—É–¥—ñ–≤–ª—è —Ç—É—Ç
    for(let b of buildings) {
        if(b.x === x && b.y === y) return true;
    }
    return false;
}

function isInWater(x, y, r) {
    for(let w of waterZones) {
        if(dist(x, y, w.x, w.y) < w.radius + r) return true;
    }
    return false;
}

// –ö–ª—ñ–∫ –º–∏—à—ñ
function onClick(e) {
    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ —Å–≤—ñ—Ç—É
    let clickX = e.clientX + camera.x;
    let clickY = e.clientY + camera.y;

    // –†–µ–∂–∏–º –±—É–¥—ñ–≤–Ω–∏—Ü—Ç–≤–∞
    if (player.equipped >= 3) {
        buildStructure(clickX, clickY);
        return;
    }

    // –†–µ–∂–∏–º –∞—Ç–∞–∫–∏ / –∑–±–æ—Ä—É
    // –®—É–∫–∞—î–º–æ –Ω–∞–π–±–ª–∏–∂—á—É —Ü—ñ–ª—å –ø—ñ–¥ –º–∏—à–∫–æ—é
    let target = null;
    for(let ent of entities) {
        if(dist(clickX, clickY, ent.x, ent.y) < ent.radius + 10) {
            target = ent;
            break;
        }
    }

    if (target) {
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–∏—Å—Ç–∞–Ω—Ü—ñ—ó
        if(dist(player.x, player.y, target.x, target.y) > 100) {
            showNotify("–ù–∞–¥—Ç–æ –¥–∞–ª–µ–∫–æ!");
            return;
        }
        
        // –£–¥–∞—Ä
        harvest(target);
    }
}

function interact() {
    // –î—ñ—è –Ω–∞ 'E' (–≤—ñ–¥–∫—Ä–∏—Ç–∏ –¥–≤–µ—Ä—ñ)
    let px = player.x;
    let py = player.y;
    buildings.forEach(b => {
        if(b.type === TYPE_DOOR) {
            let centerBx = b.x + b.w/2;
            let centerBy = b.y + b.h/2;
            if(dist(px, py, centerBx, centerBy) < 60) {
                b.isOpen = !b.isOpen;
            }
        }
    });
}

function harvest(target) {
    let damage = 1;
    // –ë–æ–Ω—É—Å–∏ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤
    if(target.type === TYPE_TREE && player.equipped === 1) damage = 5; // Axe vs Tree
    if(target.type === TYPE_ROCK && player.equipped === 2) damage = 5; // Pick vs Rock
    if(target.type === TYPE_BUSH) damage = 5; // Instakill bush

    target.hp -= damage;

    // –ê–Ω—ñ–º–∞—Ü—ñ—è "—Ç—Ä—è—Å–∫–∏"
    target.x += (Math.random()-0.5)*5;

    if(target.hp <= 0) {
        // –í–∏–¥–∞–ª–µ–Ω–Ω—è
        entities.splice(entities.indexOf(target), 1);
        // –õ—É—Ç
        if(target.type === TYPE_TREE) { player.inv.wood += 5; showNotify("+5 –î–µ—Ä–µ–≤–∞"); }
        if(target.type === TYPE_ROCK) { player.inv.stone += 5; showNotify("+5 –ö–∞–º–µ–Ω—é"); }
        if(target.type === TYPE_BUSH) { player.inv.food += 2; showNotify("+2 –Ø–≥–æ–¥–∏"); }
    }
    updateUI();
}

function buildStructure(mx, my) {
    let gx = Math.floor(mx / TILE_SIZE) * TILE_SIZE;
    let gy = Math.floor(my / TILE_SIZE) * TILE_SIZE;

    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–∏—Å—Ç–∞–Ω—Ü—ñ—ó
    if (dist(player.x, player.y, gx + TILE_SIZE/2, gy + TILE_SIZE/2) > 150) {
        showNotify("–ù–∞–¥—Ç–æ –¥–∞–ª–µ–∫–æ!");
        return;
    }

    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ –≤—ñ–ª—å–Ω–æ
    if (checkCollisionRect(gx, gy, TILE_SIZE, TILE_SIZE)) {
        showNotify("–¢—É—Ç –Ω–µ –º–æ–∂–Ω–∞ –±—É–¥—É–≤–∞—Ç–∏!");
        return;
    }

    let type = null;
    let cost = {};

    if(player.equipped === 3) { // Wall
        type = TYPE_WALL;
        cost = { wood: 20 };
    } else if (player.equipped === 4) { // Door
        type = TYPE_DOOR;
        cost = { wood: 30 };
    } else if (player.equipped === 5) { // Fire
        type = TYPE_FIRE;
        cost = { wood: 10, stone: 10 };
    }

    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–µ—Å—É—Ä—Å—ñ–≤
    if(player.inv.wood >= (cost.wood || 0) && player.inv.stone >= (cost.stone || 0)) {
        player.inv.wood -= (cost.wood || 0);
        player.inv.stone -= (cost.stone || 0);
        
        let building = { x: gx, y: gy, w: TILE_SIZE, h: TILE_SIZE, type: type };
        if(type === TYPE_DOOR) building.isOpen = false;
        
        buildings.push(building);
        showNotify("–ó–±—É–¥–æ–≤–∞–Ω–æ!");
        updateUI();
    } else {
        showNotify("–ù–µ –≤–∏—Å—Ç–∞—á–∞—î —Ä–µ—Å—É—Ä—Å—ñ–≤!");
    }
}

/**
 * –Ü–ù–¢–ï–†–§–ï–ô–° –¢–ê –£–¢–ò–õ–Ü–¢–ò
 */
function selectItem(idx) {
    // –õ–æ–≥—ñ–∫–∞ –∫—Ä–∞—Ñ—Ç—É —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤
    if (idx === 1 && !player.tools.axe) { // Craft Axe
        if(player.inv.wood >= 10 && player.inv.stone >= 10) {
            player.inv.wood -= 10; player.inv.stone -= 10;
            player.tools.axe = true;
            document.querySelector('#btn-axe span:last-child').innerText = "(–ï–∫—ñ–ø)";
            showNotify("–°–æ–∫–∏—Ä—É —Å—Ç–≤–æ—Ä–µ–Ω–æ!");
            updateUI();
        } else {
            showNotify("–¢—Ä–µ–±–∞ 10 –¥–µ—Ä–µ–≤–∞ —ñ 10 –∫–∞–º–µ–Ω—é");
            return;
        }
    }
    if (idx === 2 && !player.tools.pickaxe) { // Craft Pickaxe
        if(player.inv.wood >= 10 && player.inv.stone >= 10) {
            player.inv.wood -= 10; player.inv.stone -= 10;
            player.tools.pickaxe = true;
            document.querySelector('#btn-pick span:last-child').innerText = "(–ï–∫—ñ–ø)";
            showNotify("–ö–∏—Ä–∫—É —Å—Ç–≤–æ—Ä–µ–Ω–æ!");
            updateUI();
        } else {
            showNotify("–¢—Ä–µ–±–∞ 10 –¥–µ—Ä–µ–≤–∞ —ñ 10 –∫–∞–º–µ–Ω—é");
            return;
        }
    }

    player.equipped = idx;
    
    // UI –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–ª–æ—Ç—É
    document.querySelectorAll('.slot').forEach((el, i) => {
        // –ø–µ—Ä—à—ñ 3 —Å–ª–æ—Ç–∏ - —Ü–µ —Ä–µ—Å—É—Ä—Å–∏, –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ —ó—Ö –≤ —Ü–∏–∫–ª—ñ –∫–Ω–æ–ø–æ–∫
        if(i >= 3) {
            if (i - 3 === idx) el.classList.add('active');
            else el.classList.remove('active');
        }
    });
}

function eatFood() {
    if(player.inv.food > 0 && player.hunger < 100) {
        player.inv.food--;
        player.hunger = Math.min(100, player.hunger + 20);
        player.hp = Math.min(100, player.hp + 5);
        showNotify("–ù—è–º-–Ω—è–º!");
        updateUI();
    } else if (player.inv.food === 0) {
        showNotify("–ù–µ–º–∞—î —ó–∂—ñ!");
    } else {
        showNotify("–Ø –Ω–µ –≥–æ–ª–æ–¥–Ω–∏–π.");
    }
}

function updateUI() {
    document.getElementById('hp-bar').style.width = player.hp + '%';
    document.getElementById('hunger-bar').style.width = player.hunger + '%';
    
    document.getElementById('res-wood').innerText = player.inv.wood;
    document.getElementById('res-stone').innerText = player.inv.stone;
    document.getElementById('res-food').innerText = player.inv.food;
}

function showNotify(msg) {
    let el = document.getElementById('notification');
    el.innerText = msg;
    el.style.opacity = 1;
    setTimeout(() => { el.style.opacity = 0; }, 1500);
}

function dist(x1, y1, x2, y2) {
    return Math.sqrt((x2-x1)**2 + (y2-y1)**2);
}

// –°—Ç–∞—Ä—Ç
init();

</script>
</body>
</html>
