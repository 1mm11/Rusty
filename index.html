<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>Rust 2D Canvas</title>
<style>
    body { margin: 0; overflow: hidden; background: #111; font-family: 'Segoe UI', sans-serif; user-select: none; }
    canvas { display: block; cursor: crosshair; }
    
    /* UI Overlay */
    #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
    
    /* HUD Bottom */
    #hud {
        position: absolute; bottom: 20px; right: 20px;
        display: flex; flex-direction: column; align-items: flex-end; gap: 10px;
    }
    .stat-bar {
        width: 200px; height: 15px; background: rgba(0,0,0,0.7); border: 1px solid #555; position: relative;
    }
    .stat-fill { height: 100%; transition: width 0.2s; }
    #hp-bar .stat-fill { background: #8bc34a; }
    #food-bar .stat-fill { background: #ff9800; }
    .stat-text { position: absolute; right: 5px; top: -2px; font-size: 10px; color: white; font-weight: bold; }

    /* Hotbar */
    #hotbar {
        position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
        display: flex; gap: 5px; pointer-events: auto;
    }
    .slot {
        width: 60px; height: 60px; background: rgba(40, 40, 40, 0.85); border: 2px solid #555;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        color: white; font-size: 10px; position: relative; cursor: pointer; transition: 0.1s;
    }
    .slot.active { border-color: #4caf50; box-shadow: 0 0 10px #4caf50; transform: scale(1.05); }
    .slot:hover { background: rgba(60,60,60,0.9); }
    .count { position: absolute; bottom: 2px; right: 2px; font-size: 14px; font-weight: bold; text-shadow: 1px 1px 0 #000; }
    .item-icon { font-size: 24px; }

    /* Menus (Inventory / Crafting) */
    .modal {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: rgba(30, 30, 30, 0.95); border: 1px solid #777; padding: 20px;
        display: none; pointer-events: auto; color: white; box-shadow: 0 0 30px black;
        flex-direction: row; gap: 20px; border-radius: 5px;
    }
    
    /* Inventory Specific */
    .char-preview {
        width: 150px; height: 200px; background: #222; border: 1px solid #444;
        display: flex; align-items: center; justify-content: center; position: relative;
    }
    .armor-slots { display: flex; flex-direction: column; gap: 5px; position: absolute; left: -40px; top: 0; }
    .inv-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; }

    /* Crafting Specific */
    .craft-list { display: flex; flex-direction: column; gap: 5px; max-height: 400px; overflow-y: auto; width: 250px; }
    .craft-btn {
        background: #444; padding: 10px; display: flex; justify-content: space-between; align-items: center;
        cursor: pointer; border: 1px solid #555;
    }
    .craft-btn:hover { background: #555; }
    .craft-cost { font-size: 10px; color: #ccc; }

    /* Start Screen */
    #start-screen {
        position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8);
        display: flex; justify-content: center; align-items: center; color: white; flex-direction: column; pointer-events: auto;
    }
    h1 { margin: 0 0 10px 0; color: #ff5722; font-size: 48px; }

    /* Notifications */
    #notify-area {
        position: absolute; top: 70%; right: 20px; display: flex; flex-direction: column; gap: 5px; pointer-events: none;
    }
    .msg { background: rgba(0,0,0,0.6); color: #fff; padding: 5px 10px; border-left: 3px solid #4caf50; font-size: 14px; animation: fadeOut 3s forwards; }
    @keyframes fadeOut { 0% {opacity:1;} 80% {opacity:1;} 100% {opacity:0; display:none;} }

</style>
</head>
<body>

<canvas id="game"></canvas>

<div id="ui-layer">
    <div id="notify-area"></div>

    <div id="hud">
        <div class="stat-bar" id="hp-bar"><div class="stat-fill" style="width: 100%;"></div><span class="stat-text">HP 100</span></div>
        <div class="stat-bar" id="food-bar"><div class="stat-fill" style="width: 80%;"></div><span class="stat-text">FOOD 100</span></div>
    </div>

    <div id="hotbar">
        </div>
</div>

<div id="inv-menu" class="modal">
    <div>
        <h3>–°–ø–æ—Ä—è–¥–∂–µ–Ω–Ω—è</h3>
        <div class="char-preview">
            <div id="player-render-ui"></div> <div class="armor-slots">
                <div class="slot" id="slot-head">üé©</div>
                <div class="slot" id="slot-chest">üëï</div>
                <div class="slot" id="slot-legs">üëñ</div>
            </div>
        </div>
    </div>
    <div>
        <h3>–†—é–∫–∑–∞–∫</h3>
        <div class="inv-grid" id="main-inv-grid"></div>
        <div style="margin-top: 20px; font-size: 12px; color: #aaa;">
            –ö–ª—ñ–∫–Ω–∏, —â–æ–± –≤–∏–±—Ä–∞—Ç–∏ –ø—Ä–µ–¥–º–µ—Ç -> –ö–ª—ñ–∫–Ω–∏, —â–æ–± –ø–µ—Ä–µ–º—ñ—Å—Ç–∏—Ç–∏.
        </div>
    </div>
</div>

<div id="craft-menu" class="modal">
    <div>
        <h3>–ö—Ä–∞—Ñ—Ç</h3>
        <div class="craft-list" id="craft-list-ui">
            </div>
    </div>
</div>

<div id="start-screen">
    <h1>RUST 2D</h1>
    <p>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å —Å—é–¥–∏, —â–æ–± –ø—Ä–æ–∫–∏–Ω—É—Ç–∏—Å—å –Ω–∞ –ø–ª—è–∂—ñ</p>
    <p style="font-size: 14px; color: #aaa;">WASD - –†—É—Ö | –ú–∏—à–∞ - –û–≥–ª—è–¥/–ê—Ç–∞–∫–∞ | 1-6 - –ü–æ—è—Å</p>
    <p style="font-size: 14px; color: #aaa;">E - –Ü–Ω–≤–µ–Ω—Ç–∞—Ä | Q - –ö—Ä–∞—Ñ—Ç | –õ–ö–ú - –î—ñ—è</p>
</div>

<script>
/**
 * –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø
 */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const uiHotbar = document.getElementById('hotbar');
const uiInv = document.getElementById('inv-menu');
const uiCraft = document.getElementById('craft-menu');
const uiStart = document.getElementById('start-screen');

// –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏
const TILE = 50;
const MAP_W = 2000;
const MAP_H = 2000;

// –°—Ç–∞–Ω –≥—Ä–∏
let gameState = 'start'; // start, play, inv, craft
let camX = 0, camY = 0;
let mouse = { x: 0, y: 0, wx: 0, wy: 0 };
let keys = {};
let dayTime = 0; // 0..1 (0.5 = noon)

// –ó–≤—É–∫–∏ (—ñ–º—ñ—Ç–∞—Ü—ñ—è)
function playSound(type) { /* –¢—É—Ç –º–æ–≥–ª–∏ –±—É—Ç–∏ –∑–≤—É–∫–∏ */ }

/**
 * –ü–†–ï–î–ú–ï–¢–ò –¢–ê –ë–ê–ó–ê –î–ê–ù–ò–•
 */
const ITEMS = {
    rock: { name: "–ö–∞–º—ñ–Ω—å", icon: "ü™®", type: "tool", dmg: 10, range: 40 },
    torch: { name: "–§–∞–∫–µ–ª", icon: "üî•", type: "tool", dmg: 5, range: 40, light: true },
    wood: { name: "–î–µ—Ä–µ–≤–æ", icon: "üå≤", type: "res" },
    stone: { name: "–†—É–¥–∞", icon: "üåë", type: "res" },
    scrap: { name: "–°–∫—Ä–∞–ø", icon: "‚öôÔ∏è", type: "comp" },
    cloth: { name: "–¢–∫–∞–Ω–∏–Ω–∞", icon: "üß∂", type: "comp" },
    axe: { name: "–°–æ–∫–∏—Ä–∞", icon: "ü™ì", type: "tool", dmg: 25, range: 50, bonus: 'tree' },
    pickaxe: { name: "–ö–∏—Ä–∫–∞", icon: "‚õèÔ∏è", type: "tool", dmg: 25, range: 50, bonus: 'rock' },
    plan: { name: "Plan", icon: "üìù", type: "build" }, // Building Plan
    wall_item: { name: "–°—Ç—ñ–Ω–∞", icon: "üß±", type: "placeable", buildType: "wall" }, // Virtual item for internal logic
    door_item: { name: "–î–≤–µ—Ä—ñ", icon: "üö™", type: "placeable", buildType: "door" },
    ak47: { name: "AK-47", icon: "üî´", type: "gun", dmg: 15, range: 300, rate: 10 },
    berry: { name: "–Ø–≥–æ–¥–∏", icon: "üçí", type: "food", val: 10 }
};

const RECIPES = [
    { id: 'axe', name: '–ö–∞–º\'—è–Ω–∞ —Å–æ–∫–∏—Ä–∞', cost: { wood: 30, stone: 10 }, out: 1 },
    { id: 'pickaxe', name: '–ö–∞–º\'—è–Ω–∞ –∫–∏—Ä–∫–∞', cost: { wood: 30, stone: 10 }, out: 1 },
    { id: 'plan', name: 'Building Plan', cost: { wood: 20 }, out: 1 }, // –ü–∞–ø—ñ—Ä –¥–ª—è –±—É–¥—ñ–≤–Ω–∏—Ü—Ç–≤–∞
    { id: 'torch', name: '–§–∞–∫–µ–ª', cost: { wood: 10, cloth: 5 }, out: 1 },
    { id: 'ak47', name: 'AK-47', cost: { wood: 50, scrap: 100, stone: 50 }, out: 1 } // –î–æ—Ä–æ–≥–æ
];

/**
 * –ì–†–ê–í–ï–¶–¨
 */
const player = {
    x: 100, y: MAP_H / 2, // –°–ø–∞–≤–Ω –Ω–∞ –ø–ª—è–∂—ñ (–ª—ñ–≤–æ—Ä—É—á)
    angle: 0,
    hp: 100,
    food: 100,
    speed: 4,
    inv: Array(24).fill(null), // –û—Å–Ω–æ–≤–Ω–∏–π —ñ–Ω–≤–µ–Ω—Ç–∞—Ä
    belt: Array(6).fill(null), // –ü–æ—è—Å (Hotbar)
    beltIdx: 0,
    armor: { head: null, chest: null, legs: null },
    
    addItem(id, count) {
        // –°–ø–æ—á–∞—Ç–∫—É –≤ —Å—Ç–∞–∫–∏
        for(let list of [this.belt, this.inv]) {
            for(let s of list) {
                if(s && s.id === id) {
                    s.count += count;
                    updateUI();
                    return true;
                }
            }
        }
        // –ü–æ—Ç—ñ–º –≤ –ø—É—Å—Ç—ñ
        for(let list of [this.belt, this.inv]) {
            for(let i=0; i<list.length; i++) {
                if(!list[i]) {
                    list[i] = { id: id, count: count };
                    updateUI();
                    return true;
                }
            }
        }
        notify("–Ü–Ω–≤–µ–Ω—Ç–∞—Ä –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–æ!");
        return false;
    },
    
    getHandItem() {
        return this.belt[this.beltIdx];
    }
};

// –°—Ç–∞—Ä—Ç–æ–≤—ñ –ø—Ä–µ–¥–º–µ—Ç–∏
player.belt[0] = { id: 'rock', count: 1 };
player.belt[1] = { id: 'torch', count: 1 };

/**
 * –°–í–Ü–¢
 */
let entities = [];
let buildings = [];
let zones = []; // RTs

function initWorld() {
    // 1. –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –ª–∞–Ω–¥—à–∞—Ñ—Ç—É
    // –ó–ª—ñ–≤–∞ –≤–æ–¥–∞ (x < 200), –¥–∞–ª—ñ –ø–ª—è–∂ (200-400), –¥–∞–ª—ñ —Ç—Ä–∞–≤–∞.
    // –î–æ—Ä–æ–≥–∞ –π–¥–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É Y, –∑–≤–∏–≤–∞—î—Ç—å—Å—è —Ç—Ä–æ—Ö–∏.
    
    // 2. –†–µ—Å—É—Ä—Å–∏
    for(let i=0; i<300; i++) {
        let x = 300 + Math.random() * (MAP_W - 300);
        let y = Math.random() * MAP_H;
        let type = Math.random() > 0.6 ? 'rock' : (Math.random() > 0.5 ? 'bush' : 'tree');
        
        // –ù–µ —Å–ø–∞–≤–Ω–∏—Ç–∏ –Ω–∞ –¥–æ—Ä–æ–∑—ñ
        if (Math.abs(y - MAP_H/2) < 60) continue;
        
        entities.push({
            id: Math.random(),
            x: x, y: y,
            type: type,
            hp: type === 'rock' ? 50 : 30,
            angle: Math.random() * 6.28
        });
    }

    // 3. –î–æ—Ä–æ–≥–∞ —ñ –±–æ—á–∫–∏
    for(let i=0; i<30; i++) {
        let bx = 400 + Math.random() * (MAP_W - 500);
        let by = (MAP_H / 2) + (Math.random() - 0.5) * 80; // –ë—ñ–ª—è –¥–æ—Ä–æ–≥–∏
        entities.push({ id: Math.random(), x: bx, y: by, type: 'barrel', hp: 10, angle: 0 });
    }

    // 4. –ú–æ–Ω—É–º–µ–Ω—Ç–∏ (RT)
    // –ó–∞–ø—Ä–∞–≤–∫–∞
    zones.push({ x: 800, y: MAP_H/2 - 200, w: 300, h: 200, type: 'gas_station', roofAlpha: 1 });
    // –°–ø–∞–≤–Ω —è—â–∏–∫—ñ–≤ –≤ –∑–∞–ø—Ä–∞–≤—Ü—ñ
    entities.push({ x: 850, y: MAP_H/2 - 150, type: 'crate', hp: 20 });
    
    // –°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç
    zones.push({ x: 1500, y: MAP_H/2 + 200, w: 400, h: 300, type: 'market', roofAlpha: 1 });
    entities.push({ x: 1600, y: MAP_H/2 + 300, type: 'crate', hp: 20 });
}

/**
 * LOGIC
 */
function update() {
    if(gameState !== 'play') return;
    
    // –†—É—Ö
    let dx = 0, dy = 0;
    if(keys['KeyW']) dy = -1;
    if(keys['KeyS']) dy = 1;
    if(keys['KeyA']) dx = -1;
    if(keys['KeyD']) dx = 1;
    
    // –ù–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è
    if(dx || dy) {
        let len = Math.sqrt(dx*dx + dy*dy);
        dx /= len; dy /= len;
        
        let nx = player.x + dx * player.speed;
        let ny = player.y + dy * player.speed;
        
        if(!checkCol(nx, player.y)) player.x = nx;
        if(!checkCol(player.x, ny)) player.y = ny;
    }
    
    // –ö—É—Ç –≥—Ä–∞–≤—Ü—è
    player.angle = Math.atan2(mouse.wy - player.y, mouse.wx - player.x);
    
    // –ö–∞–º–µ—Ä–∞
    camX = player.x - canvas.width / 2;
    camY = player.y - canvas.height / 2;
    
    // –û–±–º–µ–∂–µ–Ω–Ω—è –∫–∞–º–µ—Ä–∏
    camX = Math.max(0, Math.min(camX, MAP_W - canvas.width));
    camY = Math.max(0, Math.min(camY, MAP_H - canvas.height));
    
    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–æ–Ω (–¥–∞—Ö–∏)
    zones.forEach(z => {
        let inside = player.x > z.x && player.x < z.x + z.w && player.y > z.y && player.y < z.y + z.h;
        if(inside) z.roofAlpha = Math.max(0, z.roofAlpha - 0.1);
        else z.roofAlpha = Math.min(1, z.roofAlpha + 0.1);
    });

    // –ß–∞—Å
    dayTime += 0.0001;
    if(dayTime > 1) dayTime = 0;
}

function checkCol(x, y) {
    // –í–æ–¥–∞
    if(x < 200) return true;
    // –°—Ç—ñ–Ω–∏ –±—É–¥—ñ–≤–µ–ª—å –≥—Ä–∞–≤—Ü—è
    for(let b of buildings) {
        if(b.type === 'wall' && rectCol(x,y,10, b.x, b.y, 50, 50)) return true;
    }
    // –°—Ç—ñ–Ω–∏ RT (–ø—Ä–æ—Å—Ç–∏–π –±–æ–∫—Å)
    // (–°–ø—Ä–æ—â–µ–Ω–Ω—è: RT –ø—Ä–æ—Ö—ñ–¥–Ω—ñ, –æ–∫—Ä—ñ–º —Å—Ç—ñ–Ω, –∞–ª–µ —Ç—É—Ç –¥–ª—è —à–≤–∏–¥–∫–æ—Å—Ç—ñ –º–∏ –ø—Ä–æ—Å—Ç–æ —Ö–æ–¥–∏–º–æ –∫—Ä—ñ–∑—å –Ω–∏—Ö, –∫—Ä—ñ–º –±–æ—á–æ–∫)
    return false;
}
function rectCol(x,y,r, rx,ry,rw,rh) {
    return x+r > rx && x-r < rx+rw && y+r > ry && y-r < ry+rh;
}

/**
 * –ë–£–î–Ü–í–ù–ò–¶–¢–í–û –Ü –î–Ü–á
 */
function handleInput(e) {
    if(gameState === 'start') {
        gameState = 'play';
        uiStart.style.display = 'none';
        init();
        return;
    }

    // –Ü–Ω–≤–µ–Ω—Ç–∞—Ä E
    if(e.code === 'KeyE') {
        if(gameState === 'inv') { gameState = 'play'; uiInv.style.display = 'none'; }
        else { gameState = 'inv'; uiInv.style.display = 'flex'; uiCraft.style.display = 'none'; drawCharPreview(); }
    }
    // –ö—Ä–∞—Ñ—Ç Q
    if(e.code === 'KeyQ') {
        if(gameState === 'craft') { gameState = 'play'; uiCraft.style.display = 'none'; }
        else { gameState = 'craft'; uiCraft.style.display = 'flex'; uiInv.style.display = 'none'; renderCraft(); }
    }
    // –ü–æ—è—Å 1-6
    if(e.key >= '1' && e.key <= '6') {
        player.beltIdx = parseInt(e.key) - 1;
        updateUI();
    }
}

function onMouseClick(e) {
    if(gameState !== 'play') return;
    if(e.button !== 0) return; // –¢—ñ–ª—å–∫–∏ –õ–ö–ú

    let hand = player.getHandItem();
    let actionDone = false;

    // 1. –ë—É–¥—ñ–≤–Ω–∏—Ü—Ç–≤–æ (—è–∫—â–æ –≤ —Ä—É–∫–∞—Ö Plan)
    if(hand && hand.id === 'plan') {
        // –°—Ç–∞–≤–∏–º–æ —Å—Ç—ñ–Ω—É
        let bx = Math.floor(mouse.wx / 50) * 50;
        let by = Math.floor(mouse.wy / 50) * 50;
        
        // –í–∏—Ç—Ä–∞—á–∞—î–º–æ –¥–µ—Ä–µ–≤–æ
        let woodSlot = findItem('wood');
        if(woodSlot && woodSlot.count >= 20) {
            woodSlot.count -= 20;
            if(woodSlot.count <= 0) removeItem('wood');
            buildings.push({ x: bx, y: by, type: 'wall', hp: 200 });
            notify("-20 –î–µ—Ä–µ–≤–∞ (–°—Ç—ñ–Ω–∞)");
            updateUI();
        } else {
            notify("–¢—Ä–µ–±–∞ 20 –¥–µ—Ä–µ–≤–∞!");
        }
        return;
    }

    // 2. –ê—Ç–∞–∫–∞ / –î–æ–±—É–≤–∞–Ω–Ω—è
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–∏—Å—Ç–∞–Ω—Ü—ñ—ó –¥–æ –∫—É—Ä—Å–æ—Ä–∞
    let hits = [];
    entities.forEach((ent, i) => {
        let dist = Math.hypot(ent.x - mouse.wx, ent.y - mouse.wy);
        if(dist < 30 && Math.hypot(player.x - ent.x, player.y - ent.y) < 100) {
            hits.push({ ent, i });
        }
    });

    if(hits.length > 0) {
        let target = hits[0].ent;
        let dmg = 1;
        if(hand && ITEMS[hand.id].dmg) dmg = ITEMS[hand.id].dmg;
        
        // –ë–æ–Ω—É—Å–∏
        if(hand && ITEMS[hand.id].bonus === 'tree' && target.type === 'tree') dmg *= 3;
        if(hand && ITEMS[hand.id].bonus === 'rock' && (target.type === 'rock' || target.type === 'barrel')) dmg *= 3;

        target.hp -= dmg;
        // –ï—Ñ–µ–∫—Ç —É–¥–∞—Ä—É (–∑–¥—Ä–∏–≥–∞–Ω–Ω—è)
        target.shake = 5;

        if(target.hp <= 0) {
            // Drop
            entities.splice(hits[0].i, 1);
            if(target.type === 'tree') { player.addItem('wood', 50); notify("+50 –î–µ—Ä–µ–≤–∞"); }
            if(target.type === 'rock') { player.addItem('stone', 30); notify("+30 –†—É–¥–∏"); }
            if(target.type === 'barrel') { 
                player.addItem('scrap', 5); 
                player.addItem('cloth', 2);
                notify("+Scrap +Cloth"); 
            }
            if(target.type === 'bush') { player.addItem('berry', 5); notify("+5 –Ø–≥—ñ–¥"); }
            if(target.type === 'crate') { player.addItem('ak47', 1); notify("–ó–Ω–∞–π–¥–µ–Ω–æ AK-47!"); }
        }
    } else {
        // –°—Ç—Ä—ñ–ª—å–±–∞ (—è–∫—â–æ –∑–±—Ä–æ—è)
        // (–°–ø—Ä–æ—â–µ–Ω–æ: –ø—Ä–æ—Å—Ç–æ –∑–≤—É–∫/–µ—Ñ–µ–∫—Ç, –±–æ –Ω–µ–º–∞ –≤–æ—Ä–æ–≥—ñ–≤ –ø–æ–∫–∏)
    }
}

function findItem(id) {
    let s = player.belt.find(x => x && x.id === id);
    if(s) return s;
    return player.inv.find(x => x && x.id === id);
}
function removeItem(id) {
    // –°–ø—Ä–æ—â–µ–Ω–æ –¥–ª—è –ø—Ä–∏–∫–ª–∞–¥—É
    for(let i=0; i<player.belt.length; i++) if(player.belt[i] && player.belt[i].id==id) player.belt[i]=null;
    for(let i=0; i<player.inv.length; i++) if(player.inv[i] && player.inv[i].id==id) player.inv[i]=null;
}

/**
 * –†–ï–ù–î–ï–†–ò–ù–ì
 */
function draw() {
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    if(gameState === 'start') return;

    // –ö–∞–º–µ—Ä–∞
    ctx.translate(-camX, -camY);

    // 1. –ó–µ–º–ª—è
    drawGround();

    // 2. –î–æ—Ä–æ–≥–∞
    ctx.fillStyle = '#444';
    ctx.fillRect(0, MAP_H/2 - 40, MAP_W, 80);
    ctx.strokeStyle = '#fff';
    ctx.setLineDash([20, 20]);
    ctx.beginPath(); ctx.moveTo(0, MAP_H/2); ctx.lineTo(MAP_W, MAP_H/2); ctx.stroke();
    ctx.setLineDash([]);

    // 3. –ü—ñ–¥–ª–æ–≥–∞ –±—É–¥—ñ–≤–µ–ª—å
    zones.forEach(z => {
        ctx.fillStyle = '#333';
        ctx.fillRect(z.x, z.y, z.w, z.h);
    });

    // 4. –û–±'—î–∫—Ç–∏ —Å–≤—ñ—Ç—É (–°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –ø–æ Y –¥–ª—è "–≥–ª–∏–±–∏–Ω–∏")
    let renderList = [...entities, ...buildings, player];
    renderList.sort((a,b) => a.y - b.y);

    renderList.forEach(obj => {
        if(obj === player) drawPlayer();
        else if(obj.type === 'wall') {
            ctx.fillStyle = '#8d6e63'; ctx.fillRect(obj.x, obj.y, 50, 50);
            ctx.fillStyle = '#5d4037'; ctx.fillRect(obj.x+5, obj.y+5, 40, 40); // Detail
        }
        else drawEntity(obj);
    });

    // 5. –î–∞—Ö–∏
    zones.forEach(z => {
        if(z.roofAlpha > 0.01) {
            ctx.globalAlpha = z.roofAlpha;
            ctx.fillStyle = z.type === 'gas_station' ? '#c0392b' : '#2980b9'; // –ß–µ—Ä–≤–æ–Ω–∏–π/–°–∏–Ω—ñ–π –¥–∞—Ö
            ctx.fillRect(z.x, z.y, z.w, z.h);
            ctx.strokeStyle = '#222'; ctx.strokeRect(z.x, z.y, z.w, z.h);
            
            // –ù–∞–ø–∏—Å
            ctx.fillStyle = 'white'; ctx.font = '20px Arial'; ctx.textAlign = 'center';
            ctx.fillText(z.type === 'gas_station' ? "–ó–ê–ü–†–ê–í–ö–ê" : "–°–£–ü–ï–†–ú–ê–†–ö–ï–¢", z.x + z.w/2, z.y + z.h/2);
            ctx.globalAlpha = 1;
        }
    });

    // 6. –ù—ñ—á
    // (–°–ø—Ä–æ—â–µ–Ω–æ: –ø—Ä–æ—Å—Ç–æ —Å–∏–Ω—ñ–π –æ–≤–µ—Ä–ª–µ–π)
    // drawNightOverlay();
    
    // 7. –ï—Ñ–µ–∫—Ç–∏ –∫—É—Ä—Å–æ—Ä–∞ (–ë—É–¥—ñ–≤–Ω–∏—Ü—Ç–≤–æ)
    let hand = player.getHandItem();
    if(hand && hand.id === 'plan') {
        let bx = Math.floor(mouse.wx / 50) * 50;
        let by = Math.floor(mouse.wy / 50) * 50;
        ctx.fillStyle = 'rgba(46, 204, 113, 0.5)';
        ctx.fillRect(bx, by, 50, 50);
    }
}

function drawGround() {
    // –í–æ–¥–∞
    ctx.fillStyle = '#2980b9';
    ctx.fillRect(0, 0, 200, MAP_H);
    // –ü—ñ—Å–æ–∫
    ctx.fillStyle = '#f1c40f';
    ctx.fillRect(200, 0, 200, MAP_H);
    // –¢—Ä–∞–≤–∞
    ctx.fillStyle = '#558b2f';
    ctx.fillRect(400, 0, MAP_W-400, MAP_H);
}

function drawEntity(e) {
    ctx.save();
    ctx.translate(e.x, e.y);
    if(e.shake) { ctx.translate(Math.random()*5, Math.random()*5); e.shake--; }

    if(e.type === 'tree') {
        // –°—Ç–æ–≤–±—É—Ä
        ctx.fillStyle = '#5d4037';
        ctx.beginPath(); ctx.arc(0, 0, 10, 0, 6.28); ctx.fill();
        // –ö—Ä–æ–Ω–∞ (–ø—É—Ö–Ω–∞—Å—Ç–∞)
        ctx.fillStyle = '#2e7d32';
        for(let i=0; i<5; i++) {
            ctx.beginPath(); ctx.arc(Math.sin(i)*15, Math.cos(i)*15, 15, 0, 6.28); ctx.fill();
        }
    } else if (e.type === 'rock') {
        ctx.fillStyle = '#7f8c8d';
        ctx.beginPath();
        ctx.moveTo(-15, -10); ctx.lineTo(10, -15); ctx.lineTo(15, 10); ctx.lineTo(-10, 15);
        ctx.fill();
    } else if (e.type === 'barrel') {
        ctx.fillStyle = '#2980b9'; // Blue barrel
        ctx.beginPath(); ctx.arc(0, 0, 12, 0, 6.28); ctx.fill();
        ctx.strokeStyle = '#ecf0f1'; ctx.lineWidth = 2; ctx.stroke();
    } else if (e.type === 'bush') {
        ctx.fillStyle = '#8bc34a';
        ctx.beginPath(); ctx.arc(0, 0, 12, 0, 6.28); ctx.fill();
    } else if (e.type === 'crate') {
        ctx.fillStyle = '#795548';
        ctx.fillRect(-15, -15, 30, 30);
        ctx.strokeStyle = '#d7ccc8'; ctx.strokeRect(-15, -15, 30, 30);
    }
    ctx.restore();
}

function drawPlayer() {
    ctx.save();
    ctx.translate(player.x, player.y);
    ctx.rotate(player.angle);

    // –¢—ñ–ª–æ (—à–∫—ñ—Ä–∞)
    ctx.fillStyle = '#ffcc80'; // Peach
    // –õ—ñ–≤–∞ —Ä—É–∫–∞
    ctx.beginPath(); ctx.arc(10, -10, 6, 0, 6.28); ctx.fill();
    // –ü—Ä–∞–≤–∞ —Ä—É–∫–∞
    ctx.beginPath(); ctx.arc(10, 10, 6, 0, 6.28); ctx.fill();
    
    // –¢–æ—Ä—Å + –¢—Ä—É—Å–∏
    ctx.fillStyle = '#ffcc80';
    ctx.beginPath(); ctx.ellipse(-5, 0, 12, 18, 0, 0, 6.28); ctx.fill();
    ctx.fillStyle = '#eee'; // –¢—Ä—É—Å–∏
    ctx.fillRect(-10, -8, 10, 16);

    // –ì–æ–ª–æ–≤–∞
    ctx.fillStyle = '#ffcc80';
    ctx.beginPath(); ctx.arc(0, 0, 11, 0, 6.28); ctx.fill();
    
    // –ü—Ä–µ–¥–º–µ—Ç –≤ —Ä—É–∫–∞—Ö
    let item = player.getHandItem();
    if(item) {
        let meta = ITEMS[item.id];
        // –†—É–∫–∞ –≤–∏—Ç—è–≥–Ω—É—Ç–∞
        ctx.fillStyle = '#ffcc80';
        ctx.beginPath(); ctx.arc(20, 8, 5, 0, 6.28); ctx.fill();
        
        // –°–∞–º –ø—Ä–µ–¥–º–µ—Ç
        if(item.id === 'rock') {
            ctx.fillStyle = '#7f8c8d'; ctx.beginPath(); ctx.arc(25, 8, 8, 0, 6.28); ctx.fill();
        } else if (item.id === 'torch') {
            ctx.fillStyle = '#6d4c41'; ctx.fillRect(20, 5, 20, 6);
            ctx.fillStyle = '#ff5722'; ctx.beginPath(); ctx.arc(40, 8, 5, 0, 6.28); ctx.fill(); // –í–æ–≥–æ–Ω—å
        } else if (item.id === 'ak47') {
            ctx.fillStyle = '#222'; ctx.fillRect(20, 5, 30, 6);
            ctx.fillStyle = '#8d6e63'; ctx.fillRect(20, 5, 10, 6); // –ü—Ä–∏–∫–ª–∞–¥
        } else if (item.id === 'plan') {
            ctx.fillStyle = '#3498db'; ctx.fillRect(20, 0, 15, 15); // –ü–∞–ø—ñ—Ä–µ—Ü—å
        }
    }

    ctx.restore();
}

/**
 * UI & –°–ò–°–¢–ï–ú–ê (Inventory / Crafting)
 */
function updateUI() {
    // Hotbar
    uiHotbar.innerHTML = '';
    player.belt.forEach((slot, i) => {
        let div = document.createElement('div');
        div.className = 'slot ' + (i === player.beltIdx ? 'active' : '');
        if(slot) {
            div.innerHTML = `<span class="item-icon">${ITEMS[slot.id].icon}</span><span class="count">${slot.count > 1 ? slot.count : ''}</span>`;
        }
        div.onclick = () => { player.beltIdx = i; updateUI(); };
        uiHotbar.appendChild(div);
    });
    
    // Main Inv
    if(gameState === 'inv') {
        const grid = document.getElementById('main-inv-grid');
        grid.innerHTML = '';
        player.inv.forEach((slot, i) => {
            let div = document.createElement('div');
            div.className = 'slot';
            if(slot) div.innerHTML = `<span class="item-icon">${ITEMS[slot.id].icon}</span><span class="count">${slot.count > 1 ? slot.count : ''}</span>`;
            
            // –ü—Ä–æ—Å—Ç–∏–π Drag/Drop —á–µ—Ä–µ–∑ –∫–ª—ñ–∫
            div.onclick = () => handleInvClick('inv', i);
            grid.appendChild(div);
        });
    }
}

// –ü—Ä–æ—Å—Ç–∞ –ª–æ–≥—ñ–∫–∞ –ø–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è (Select -> Move)
let selectedSlot = null; // { list: 'inv'/'belt', idx: 0 }

function handleInvClick(listName, idx) {
    let list = listName === 'inv' ? player.inv : player.belt;
    
    if(!selectedSlot) {
        if(list[idx]) {
            selectedSlot = { list: listName, idx: idx };
            notify("–í–∏–±—Ä–∞–Ω–æ: " + ITEMS[list[idx].id].name);
        }
    } else {
        // Swap
        let srcList = selectedSlot.list === 'inv' ? player.inv : player.belt;
        let temp = srcList[selectedSlot.idx];
        srcList[selectedSlot.idx] = list[idx];
        list[idx] = temp;
        selectedSlot = null;
        updateUI();
    }
}

function renderCraft() {
    let list = document.getElementById('craft-list-ui');
    list.innerHTML = '';
    RECIPES.forEach(r => {
        let btn = document.createElement('div');
        btn.className = 'craft-btn';
        
        let costStr = Object.entries(r.cost).map(([k,v]) => `${ITEMS[k].icon} ${v}`).join(' ');
        
        btn.innerHTML = `<span>${r.name}</span><span class="craft-cost">${costStr}</span>`;
        btn.onclick = () => craftItem(r);
        list.appendChild(btn);
    });
}

function craftItem(recipe) {
    // Check cost
    for(let [key, val] of Object.entries(recipe.cost)) {
        let has = 0;
        player.inv.forEach(s => { if(s && s.id === key) has += s.count; });
        player.belt.forEach(s => { if(s && s.id === key) has += s.count; });
        
        if(has < val) { notify("–ù–µ –≤–∏—Å—Ç–∞—á–∞—î —Ä–µ—Å—É—Ä—Å—ñ–≤!"); return; }
    }
    
    // Deduct
    for(let [key, val] of Object.entries(recipe.cost)) {
        let needed = val;
        // Belt
        for(let s of player.belt) {
            if(needed <= 0) break;
            if(s && s.id === key) {
                let take = Math.min(s.count, needed);
                s.count -= take; needed -= take;
                if(s.count <= 0) { s.id = null; s.count = 0; } // Hacky clear
            }
        }
        // Inv
        if(needed > 0) {
            for(let s of player.inv) {
                if(needed <= 0) break;
                if(s && s.id === key) {
                    let take = Math.min(s.count, needed);
                    s.count -= take; needed -= take;
                }
            }
        }
        // Cleanup empty slots
        player.belt = player.belt.map(s => s && s.count > 0 ? s : null);
        player.inv = player.inv.map(s => s && s.count > 0 ? s : null);
    }
    
    player.addItem(recipe.id, recipe.out);
    notify("–°–∫—Ä–∞—Ñ—á–µ–Ω–æ: " + recipe.name);
    updateUI();
}

function notify(msg) {
    let el = document.createElement('div');
    el.className = 'msg';
    el.innerText = msg;
    document.getElementById('notify-area').appendChild(el);
    setTimeout(() => el.remove(), 3500);
}

function drawCharPreview() {
    // –û–∫—Ä–µ–º–∏–π –º—ñ–Ω—ñ-—Ä–µ–Ω–¥–µ—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –≤ –º–µ–Ω—é
    // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç–∏ –ø–æ–∫–∏ —â–æ –ø—É—Å—Ç–∏–π, –±–æ –º–∏ –º–∞—î–º–æ –π–æ–≥–æ —É –≥—Ä—ñ
}

// Event Listeners
window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });
window.addEventListener('keydown', e => keys[e.code] = true);
window.addEventListener('keyup', e => {
    keys[e.code] = false;
    handleInput(e);
});
window.addEventListener('mousemove', e => {
    mouse.x = e.clientX; mouse.y = e.clientY;
    mouse.wx = mouse.x + camX; mouse.wy = mouse.y + camY;
});
window.addEventListener('mousedown', onMouseClick);

function init() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    initWorld();
    updateUI();
    loop();
}

function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}

</script>
</body>
</html>
