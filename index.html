# =============================================================
# СИСТЕМА СУНДУКА СМЕРТИ (GROUND CHECK & DOUBLE CHEST)
# =============================================================

options:
    chest_name: &6&lМогила &7- &e%player%
    death_ban_time: 30 minutes

on death:
    if victim is a player:
        set {_items::*} to all items in victim's inventory
        clear drops
        
        # --- Поиск земли (чтобы не висел в воздухе) ---
        set {_loc} to location of victim
        while block at {_loc} is air:
            subtract 1 from y-coordinate of {_loc}
            if y-coordinate of {_loc} < -60: # Защита от бездны
                set y-coordinate of {_loc} to y-coordinate of victim
                exit loop
        add 1 to y-coordinate of {_loc} # Ставим НА блок, а не В блок
        
        # --- Установка сундука ---
        set block at {_loc} to chest
        set {_count} to size of {_items::*}
        
        if {_count} > 27:
            # Ставим вторую половинку рядом (на восток)
            set {_loc2} to {_loc}
            add 1 to x-coordinate of {_loc2}
            set block at {_loc2} to chest
            # Системное объединение в двойной сундук (зависит от версии, обычно майнкрафт сам их соединяет)
        
        # Заполняем вещами
        wait 2 ticks # Пауза чтобы блоки успели обновиться
        set {_chest_inv} to inventory of block at {_loc}
        set name of {_chest_inv} to "{@chest_name}"
        
        loop {_items::*}:
            add loop-value to {_chest_inv}
            
        send "&cВаши вещи в могиле на земле!" to victim
        send "&7Координаты: &f%x-coordinate of {_loc}%, %y-coordinate of {_loc}%, %z-coordinate of {_loc}%" to victim

        # --- Бан ---
        set {deathban::%victim's uuid%} to now
        kick victim due to "&c&lВЫ ПОГИБЛИ!%newline%&7Ваши вещи в сундуке на земле."

# --- Запрет входа ---
on connect:
    if {deathban::%player's uuid%} is set:
        set {_waited} to difference between {deathban::%player's uuid%} and now
        if {_waited} < {@death_ban_time}:
            set {_rem} to {@death_ban_time}
            remove {_waited} from {_rem}
            reject connection due to "&c&lВЫ МЕРТВЫ! %newline%&7Осталось: &e%{_rem}%"
        else:
            delete {deathban::%player's uuid%}

# --- Разбан ---
command /live <offline player>:
    permission: op
    trigger:
        delete {deathban::%arg-1's uuid%}
        send "&aИгрок &e%arg-1% &aвоскрешен." to player

# --- Самоуничтожение пустого сундука ---
on inventory close:
    if name of event-inventory contains "&6&lМогила":
        if event-inventory is empty:
            set {_l} to location of event-block
            # Удаляем обе части, если это был двойной сундук
            loop blocks in radius 1 around event-block:
                if loop-block is chest:
                    set block at loop-block to air
            set block at event-block to air
            play sound "block.iron_door.open" with pitch 0.5 to player
